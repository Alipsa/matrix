package gg

import org.junit.jupiter.api.Test
import se.alipsa.groovy.svg.G
import se.alipsa.matrix.core.Matrix
import se.alipsa.matrix.gg.layer.Layer

import static org.junit.jupiter.api.Assertions.*
import static se.alipsa.matrix.gg.GgPlot.*

/**
 * Test annotation_custom() functionality.
 */
class AnnotationCustomTest {

  @Test
  void testCustomClosureBasic() {
    def data = Matrix.of([
        'x': [1, 2, 3, 4],
        'y': [1, 2, 3, 4]
    ])

    def chart = ggplot(data, aes('x', 'y')) +
        geom_point() +
        annotation_custom(
            grob: { G g, Map b ->
              g.addRect()
                  .x(b.xmin as int)
                  .y(b.ymin as int)
                  .width((b.xmax - b.xmin) as int)
                  .height((b.ymax - b.ymin) as int)
                  .fill('red')
                  .addAttribute('opacity', 0.2)
            },
            xmin: 1, xmax: 3, ymin: 1, ymax: 3
        )

    assertNotNull(chart)
    assertEquals(2, chart.layers.size())

    // Verify the custom layer
    def customLayer = chart.layers[1]
    assertNotNull(customLayer)
    assertNotNull(customLayer.geom)
    assertEquals('GeomCustom', customLayer.geom.class.simpleName)
    assertFalse(customLayer.inheritAes)

    // Render to ensure no errors
    def svg = chart.render()
    assertNotNull(svg)
    assertTrue(svg.contains('<svg'))
    assertTrue(svg.contains('</svg>'))
  }

  @Test
  void testCustomInfBounds() {
    def data = Matrix.of([
        'x': [1, 2, 3, 4],
        'y': [1, 2, 3, 4]
    ])

    // Default bounds should fill entire panel
    def chart = ggplot(data, aes('x', 'y')) +
        geom_point() +
        annotation_custom(
            grob: { G g, Map b ->
              g.addCircle()
                  .cx(((b.xmin + b.xmax) / 2) as int)
                  .cy(((b.ymin + b.ymax) / 2) as int)
                  .r(10)
                  .fill('blue')
            }
        )

    assertNotNull(chart)
    assertEquals(2, chart.layers.size())

    def svg = chart.render()
    assertNotNull(svg)
    assertTrue(svg.contains('<circle'))
  }

  @Test
  void testCustomSpecificBounds() {
    def data = Matrix.of([
        'x': [1, 2, 3, 4, 5],
        'y': [1, 2, 3, 4, 5]
    ])

    def chart = ggplot(data, aes('x', 'y')) +
        geom_point() +
        annotation_custom(
            grob: { G g, Map b ->
              g.addRect()
                  .x(b.xmin as int)
                  .y(b.ymin as int)
                  .width((b.xmax - b.xmin) as int)
                  .height((b.ymax - b.ymin) as int)
                  .fill('yellow')
                  .addAttribute('opacity', 0.3)
            },
            xmin: 2, xmax: 4, ymin: 2, ymax: 4
        )

    assertNotNull(chart)

    def svg = chart.render()
    assertNotNull(svg)
    assertTrue(svg.contains('<rect'))
  }

  @Test
  void testCustomMultiple() {
    def data = Matrix.of([
        'x': [1, 2, 3, 4],
        'y': [1, 2, 3, 4]
    ])

    def chart = ggplot(data, aes('x', 'y')) +
        geom_point() +
        annotation_custom(
            grob: { G g, Map b ->
              g.addRect()
                  .x(b.xmin as int)
                  .y(b.ymin as int)
                  .width((b.xmax - b.xmin) as int)
                  .height((b.ymax - b.ymin) as int)
                  .fill('red')
                  .addAttribute('opacity', 0.2)
            },
            xmin: 1, xmax: 2, ymin: 1, ymax: 2
        ) +
        annotation_custom(
            grob: { G g, Map b ->
              g.addRect()
                  .x(b.xmin as int)
                  .y(b.ymin as int)
                  .width((b.xmax - b.xmin) as int)
                  .height((b.ymax - b.ymin) as int)
                  .fill('blue')
                  .addAttribute('opacity', 0.2)
            },
            xmin: 3, xmax: 4, ymin: 3, ymax: 4
        )

    assertNotNull(chart)
    assertEquals(3, chart.layers.size())

    def svg = chart.render()
    assertNotNull(svg)
  }

  @Test
  void testCustomWithText() {
    def data = Matrix.of([
        'x': [1, 2, 3, 4],
        'y': [1, 2, 3, 4]
    ])

    def chart = ggplot(data, aes('x', 'y')) +
        geom_point() +
        annotation_custom(
            grob: { G g, Map b ->
              g.addText()
                  .x(((b.xmin + b.xmax) / 2) as int)
                  .y(((b.ymin + b.ymax) / 2) as int)
                  .text('Custom Text')
                  .fill('black')
                  .addAttribute('font-size', '16')
            },
            xmin: 2, xmax: 3, ymin: 2, ymax: 3
        )

    assertNotNull(chart)

    def svg = chart.render()
    assertNotNull(svg)
    assertTrue(svg.contains('<text'))
    assertTrue(svg.contains('Custom Text'))
  }

  @Test
  void testCustomLayer() {
    Layer layer = annotation_custom(
        grob: { G g, Map b ->
          g.addCircle().cx(100).cy(100).r(20).fill('green')
        },
        xmin: 1, xmax: 2, ymin: 1, ymax: 2
    )

    assertNotNull(layer)
    assertNotNull(layer.geom)
    assertEquals('GeomCustom', layer.geom.class.simpleName)
    assertNotNull(layer.data)
    assertNull(layer.aes)
    assertFalse(layer.inheritAes)

    // Verify data contains bounds
    assertTrue(layer.data.columnNames().contains('xmin'))
    assertTrue(layer.data.columnNames().contains('xmax'))
    assertTrue(layer.data.columnNames().contains('ymin'))
    assertTrue(layer.data.columnNames().contains('ymax'))
  }

  @Test
  void testCustomRequiresGrob() {
    def exception = assertThrows(IllegalArgumentException) {
      annotation_custom(xmin: 1, xmax: 2)
    }

    assertTrue(exception.message.contains('grob'))
  }

  @Test
  void testCustomWithLine() {
    def data = Matrix.of([
        'x': [1, 2, 3, 4],
        'y': [1, 2, 3, 4]
    ])

    def chart = ggplot(data, aes('x', 'y')) +
        geom_point() +
        annotation_custom(
            grob: { G g, Map b ->
              g.addLine()
                  .x1(b.xmin as int)
                  .y1(b.ymin as int)
                  .x2(b.xmax as int)
                  .y2(b.ymax as int)
                  .stroke('purple')
                  .addAttribute('stroke-width', 2)
            },
            xmin: 1, xmax: 4, ymin: 1, ymax: 4
        )

    assertNotNull(chart)

    def svg = chart.render()
    assertNotNull(svg)
    assertTrue(svg.contains('<line'))
  }

  @Test
  void testCustomWithOtherAnnotations() {
    def data = Matrix.of([
        'x': [1, 2, 3, 4],
        'y': [1, 2, 3, 4]
    ])

    def chart = ggplot(data, aes('x', 'y')) +
        geom_point() +
        annotation_custom(
            grob: { G g, Map b ->
              g.addRect()
                  .x(b.xmin as int)
                  .y(b.ymin as int)
                  .width((b.xmax - b.xmin) as int)
                  .height((b.ymax - b.ymin) as int)
                  .fill('lightgray')
                  .addAttribute('opacity', 0.3)
            },
            xmin: 1, xmax: 4, ymin: 1, ymax: 4
        ) +
        annotate('text', x: 2.5, y: 2.5, label: 'Center')

    assertNotNull(chart)
    assertEquals(3, chart.layers.size())

    def svg = chart.render()
    assertNotNull(svg)
    assertTrue(svg.contains('<text'))
    assertTrue(svg.contains('Center'))
  }

  @Test
  void testCustomWithScales() {
    def data = Matrix.of([
        'x': [1, 10, 100],
        'y': [1, 10, 100]
    ])

    def chart = ggplot(data, aes('x', 'y')) +
        geom_point() +
        scale_x_log10() +
        scale_y_log10() +
        annotation_custom(
            grob: { G g, Map b ->
              g.addRect()
                  .x(b.xmin as int)
                  .y(b.ymin as int)
                  .width((b.xmax - b.xmin) as int)
                  .height((b.ymax - b.ymin) as int)
                  .fill('orange')
                  .addAttribute('opacity', 0.2)
            },
            xmin: 10, xmax: 100, ymin: 10, ymax: 100
        )

    assertNotNull(chart)

    def svg = chart.render()
    assertNotNull(svg)
    assertTrue(svg.contains('<rect'))
  }

  @Test
  void testCustomPartialInfBounds() {
    def data = Matrix.of([
        'x': [1, 2, 3, 4],
        'y': [1, 2, 3, 4]
    ])

    // Test with partial Inf bounds
    def chart = ggplot(data, aes('x', 'y')) +
        geom_point() +
        annotation_custom(
            grob: { G g, Map b ->
              g.addRect()
                  .x(b.xmin as int)
                  .y(b.ymin as int)
                  .width((b.xmax - b.xmin) as int)
                  .height((b.ymax - b.ymin) as int)
                  .fill('cyan')
                  .addAttribute('opacity', 0.2)
            },
            xmin: 2  // xmax defaults to Inf, ymin/ymax default to -Inf/Inf
        )

    assertNotNull(chart)

    def svg = chart.render()
    assertNotNull(svg)
  }

  @Test
  void testCustomClosureAccessesScales() {
    def data = Matrix.of([
        'x': [1, 2, 3, 4],
        'y': [1, 2, 3, 4]
    ])

    def chart = ggplot(data, aes('x', 'y')) +
        geom_point() +
        annotation_custom(
            grob: { G g, Map b, Map scales, coord ->
              // Closure can access scales and coord parameters
              g.addCircle()
                  .cx(((b.xmin + b.xmax) / 2) as int)
                  .cy(((b.ymin + b.ymax) / 2) as int)
                  .r(15)
                  .fill('magenta')
            },
            xmin: 1.5, xmax: 2.5, ymin: 1.5, ymax: 2.5
        )

    assertNotNull(chart)

    def svg = chart.render()
    assertNotNull(svg)
    assertTrue(svg.contains('<circle'))
  }

  @Test
  void testCustomComplexShape() {
    def data = Matrix.of([
        'x': [1, 2, 3, 4, 5],
        'y': [1, 2, 3, 4, 5]
    ])

    def chart = ggplot(data, aes('x', 'y')) +
        geom_point() +
        annotation_custom(
            grob: { G g, Map b ->
              // Draw a complex custom shape (ellipse)
              def cx = ((b.xmin + b.xmax) / 2) as int
              def cy = ((b.ymin + b.ymax) / 2) as int
              def rx = ((b.xmax - b.xmin) / 2) as int
              def ry = ((b.ymax - b.ymin) / 2) as int

              g.addEllipse()
                  .cx(cx)
                  .cy(cy)
                  .rx(rx)
                  .ry(ry)
                  .fill('none')
                  .stroke('darkgreen')
                  .addAttribute('stroke-width', 2)
            },
            xmin: 2, xmax: 4, ymin: 2, ymax: 4
        )

    assertNotNull(chart)

    def svg = chart.render()
    assertNotNull(svg)
    assertTrue(svg.contains('<ellipse'))
  }
}
