# Matrix Charts v0.5.0 Release Roadmap

This document outlines the planned work to integrate matrix-stats FormulaEvaluator
into ggplot smoothing and formula handling.

## Summary

v0.5.0 replaces ad-hoc formula parsing in GgStat with the shared FormulaEvaluator,
expands supported formula syntax toward R compatibility, and honours smoothing
methods like loess and gam.

---

## Priority 1: GgStat Integration (Must Do)

### 1.1 [ ] Replace GgStat.parseFormula with FormulaEvaluator usage
- Delegate formula parsing and term expansion to matrix-stats
- Remove or deprecate local parseFormula once coverage is complete

### 1.2 [ ] Update stat_smooth/geom_smooth parameter mapping
- Map ggplot parameters (method, formula, degree, span, se, level, n)
- Add mapping for weights/offset/subset where provided
- Validate conflicting params consistently (formula vs degree)

### 1.3 [ ] Use evaluator output consistently
- Convert evaluator FitResult into smooth output matrix (x, y, ymin, ymax)
- Ensure se bands reflect evaluator outputs for all methods

---

## Priority 2: API and Behavior Alignment (Should Do)

### 2.1 [ ] Support richer formula syntax in geom_smooth
- ., ^, /, parentheses, backticks, I(), poly(), s()
- Surface clear errors for unsupported constructs

### 2.2 [ ] Clarify data/weights/offset precedence
- Document how aes mappings and stat params combine
- Ensure weights and offsets are passed to the evaluator

---

## Priority 3: Tests (Must Do)

### 3.1 [ ] Expand GgStatTest coverage
- Delegation to FormulaEvaluator
- Interaction terms and transform terms
- Dot expansion and exclusions

### 3.2 [ ] Add regression tests for method switching
- geom_smooth(method: 'loess') and geom_smooth(method: 'gam')

### 3.3 [ ] Add tests for weights/offset/na.action
- Validate behaviour with missing values and subsets

### 3.4 [ ] Run matrix-charts tests
- Command: `./gradlew :matrix-charts:test -Pheadless=true`

---

## Priority 4: Documentation and Examples (Should Do)

### 4.1 [ ] Update ggPlot.md and README
- Document supported formula syntax and method parameters
- Include compatibility notes vs R

### 4.2 [ ] Add examples for loess and gam
- Update examples folder with new usage patterns

# TODO
NumberCoercionUtil in matrix-charts seems redundant as it is duplicating similar functionality from matrix-core ValueConverter. Investigate if it is possible to remove it and replace it with ValueConverter from matrix-core to keep things DRY (possibly updating ValueConverter with additional functionality to enable the switch over).

Check if there are any occurrences of no-idiomatic groovy in matrix-charts. Examples would be use of java.lang.Math, conversions to double or other primitives, use of new ArrayList() instead of [], use of new LinkedHashMap() instead of [:] and any other "java like" constructs when there is a better groovy alternative. In general use of double and java.lang.Math is a code smell that indicates java style docing instead of idiomatic groovy; those should be refactored unless performance is **significantly** negatively impacted. These rules are all described in AGENTS.md but seem to have been overlooked at times.

Create a plan to move gg functionality from matrix-charts into its own subproject called matrix-ggcharts. Charm and Charts in matrix-charts should be unaffected by the move from a functionality standpoint (though some things might need to be made accessible from the new ggcharts project). matrix-ggcharts should depend on matrix-charts and the gg (ggplot2 like api) should use the charm implementation for the actual implementation functionality just like today. Include moving documentation in the plan.
