# matrix-datasets v2.1.2 Roadmap

This document outlines bugs, improvements, and enhancements identified for the matrix-datasets module v2.1.2 release.

## 1. Bug Fixes

### 1.1 [x] Fix IndexOutOfBoundsException in Rdatasets methods
**Severity:** HIGH
**Location:** `src/main/groovy/se/alipsa/matrix/datasets/Rdatasets.groovy:53, 79`

**Problem:** Both `fetchInfo()` and `fetchData()` call `urlResult.toList()[0]` without checking if the result list is empty. If a dataset is not found, an `IndexOutOfBoundsException` will be thrown.

**Current code:**
```groovy
String content = urlResult.toList()[0].toURL().text  // Line 53
Matrix.builder().data(urlResult.toList()[0], ',', '"', true).build()  // Line 79
```

**Fix:** Validate the result before accessing:
```groovy
def resultList = urlResult.toList()
if (resultList.isEmpty()) {
  throw new IllegalArgumentException("Dataset not found: $packageName/$itemName")
}
```

---

### 1.2 [x] Fix null parameter check logic in Rdatasets
**Severity:** MEDIUM
**Location:** `src/main/groovy/se/alipsa/matrix/datasets/Rdatasets.groovy:45, 70`

**Problem:** The null check doesn't check `itemName` for null before calling `.isEmpty()`:
```groovy
if (packageName == null || itemName.isEmpty()) {  // itemName could be null
```

**Fix:**
```groovy
if (packageName == null || itemName == null || itemName.isEmpty()) {
```

---

### 1.3 [x] Fix test assertion message in RdatasetsTest
**Severity:** LOW
**Location:** `src/test/groovy/datasets/RdatasetsTest.groovy:34`

**Problem:** The comment/message says "should have 11 columns" but the assertion expects 12:
```groovy
assertEquals(12, mtcars.columnCount(), 'Mtcars dataset should have 11 columns')
```

**Fix:** Correct the message to say "should have 12 columns".

---

## 2. Code Quality Improvements

### 2.1 [x] Add null safety to mapDataSet() method
**Severity:** MEDIUM
**Location:** `src/main/groovy/se/alipsa/matrix/datasets/Dataset.groovy:212`

**Problem:** The method doesn't check if region exists or if subset calculations result in empty data:
```groovy
Matrix sub = ds.subset("region", { it == region })
def minOrder = Stat.min(sub['order']) - 1  // Could fail if sub is empty
```

**Fix:** Add validation before arithmetic operations.

---

### 2.2 [x] Use consistent Matrix naming approach
**Severity:** LOW
**Location:** `src/main/groovy/se/alipsa/matrix/datasets/Dataset.groovy`

**Problem:** Three different approaches are used to set matrix names:
- `withMatrixName('name')` - lines 23, 31
- `setMatrixName('name')` - line 49 (after build)
- `matrixName('name')` - lines 58, 84, 99, etc. (builder method)

**Fix:** Standardize on `matrixName()` in the builder chain per AGENTS.md fluent API patterns.

---

### 2.3 [x] Replace generic Exception with FileNotFoundException
**Severity:** LOW
**Location:** `src/main/groovy/se/alipsa/matrix/datasets/util/FileUtil.groovy:27, 32, 35`

**Problem:** Code throws generic `Exception` instead of specific `FileNotFoundException`.

**Fix:** Use `FileNotFoundException` for consistency with line 98.

---

### 2.4 [x] Use string interpolation instead of concatenation
**Severity:** LOW
**Location:** `src/main/groovy/se/alipsa/matrix/datasets/util/FileUtil.groovy:27, 32, 35, 98`

**Problem:** Uses Java-style string concatenation:
```groovy
throw new Exception(filePath + " does not exist")
```

**Fix:** Use Groovy string interpolation:
```groovy
throw new FileNotFoundException("$filePath does not exist")
```

---

## 3. Test Coverage Improvements

### 3.1 [x] Add error case tests to RdatasetsTest
**Severity:** MEDIUM
**Location:** `src/test/groovy/datasets/RdatasetsTest.groovy`

**Missing tests:**
- Test for null `packageName` parameter
- Test for null `itemName` parameter
- Test for empty `itemName` string
- Test for non-existent dataset

**Example:**
```groovy
@Test
void testFetchDataWithNullPackage() {
  assertThrows(IllegalArgumentException) {
    Rdatasets.fetchData(null, 'mtcars')
  }
}

@Test
void testFetchDataWithNonExistentDataset() {
  assertThrows(IllegalArgumentException) {
    Rdatasets.fetchData('datasets', 'nonexistent_dataset_xyz')
  }
}
```

---

### 3.2 [x] Add edge case tests to DatasetTest
**Severity:** LOW
**Location:** `src/test/groovy/datasets/DatasetTest.groovy`

**Missing tests:**
- Test `describe()` with unknown/invalid dataset name
- Test `mapData()` with invalid dataset name
- Test `mapData()` with null region parameter
- Test `fromUrl()` method

---

## 4. Documentation Updates

### 4.1 [x] Update README.md version compatibility table
**Severity:** LOW
**Location:** `README.md:80-88`

**Problem:** Version compatibility table doesn't include 2.1.2 and usage examples show outdated versions.

**Fix:**
- Add 2.1.2 to compatibility table
- Update Groovy version in examples from 5.0.2 to 5.0.4
- Update usage examples to reference current version

---

## 5. Future Enhancements (Post 2.1.2)

### 5.1 [~] Add fromFile() convenience method
**Status:** Skipped - Not needed. The matrix-csv module already provides comprehensive CSV import functionality from various sources.

---

### 5.2 [x] Add Logger implementation
Per AGENTS.md guidelines, add logging support using `se.alipsa.matrix.core.util.Logger` for error conditions and debugging.

---

### 5.3 [x] Refactor mapData() to use Map lookup
Replace the if-statement chain with a Map lookup for better maintainability:
```groovy
private static final Map<String, Closure<Matrix>> MAP_PROVIDERS = [
  'world': { -> mapWorld() },
  'usa': { -> mapUsa() },
  // etc.
]
```

---

## Summary

| Priority | Task                             | Count |
|----------|----------------------------------|-------|
| HIGH     | Bug fixes (crash prevention)     | 1     |
| MEDIUM   | Bug fixes + Code quality + Tests | 4     |
| LOW      | Code quality + Documentation     | 5     |
| Future   | Enhancements                     | 3     |

**Total tasks for 2.1.2 release:** 10 (excluding future enhancements)

---

## Dependencies

- All dependencies are currently at latest versions (as of analysis)
- No security vulnerabilities identified
- JDK 21 compatibility verified
