# Matrix-CSV v2.2.2 Roadmap

**Module Review Date**: January 22, 2026
**Current Version**: 2.2.1
**Target Release**: 2.2.2

## Executive Summary

This roadmap addresses critical bugs, code quality issues, test coverage gaps, and documentation improvements identified in the matrix-csv module. The module currently has **2 source files** with **2 test files** containing only **4 test methods** (very low coverage).

### Key Findings
- **Critical bug**: `CsvImporter.parse()` crashes on empty CSV files (IndexOutOfBoundsException at line 116)
- **Significant code duplication** in format validation logic (168 lines, lines 165-303)
- **Very low test coverage**: Only 4 test methods, many format options and input sources untested
- **Documentation gaps**: CsvImporter class and methods lack GroovyDoc entirely
- **Minor bugs**: Spelling error in exception message (line 119), wrong error message text (line 320)
- **Moderate duplication**: CsvExporter file handling logic duplicated across methods

### Module Statistics
- **Source Files**: 2 (CsvImporter: 342 lines, CsvExporter: 101 lines)
- **Test Files**: 2 (CsvImportTest: 83 lines, CsvExporterTest: 34 lines)
- **Test Methods**: 4 (very low coverage)
- **Dependencies**: Apache Commons CSV 1.14.1
- **Compilation**: @CompileStatic annotations present ‚úì

---

## Phase 0: Critical Bug Fixes üî¥

**Priority**: CRITICAL
**Estimated Impact**: Prevents application crashes

### 0.1 Fix IndexOutOfBoundsException on Empty CSV Files
**File**: `src/main/groovy/se/alipsa/matrix/csv/CsvImporter.groovy`
**Lines**: 113-120
**Issue**: Accessing `rows[0]` without checking if rows is empty causes crash

**Current Code**:
```groovy
List<List<String>> rows = parser.records*.toList()
int rowCount = 0
int ncols = rows[0].size()  // ‚ùå CRASH if CSV is empty
```

**Fix**:
```groovy
List<List<String>> rows = parser.records*.toList()
if (rows.isEmpty()) {
  // Return empty Matrix with proper structure
  return new Matrix([:], tableName ?: 'matrix')
}
int rowCount = 0
int ncols = rows[0].size()
```

**Testing**:
- Add test case for completely empty CSV file
- Add test case for CSV with only headers (no data rows)
- Run `./gradlew :matrix-csv:test --tests "CsvImportTest"`

### 0.2 Fix Typo in Error Message
**File**: `src/main/groovy/se/alipsa/matrix/csv/CsvImporter.groovy`
**Line**: 119
**Issue**: "extected" should be "expected"

**Before**:
```groovy
throw new IllegalArgumentException("Row $row has $cols number of columns, extected $ncols")
```

**After**:
```groovy
throw new IllegalArgumentException("Row $row has $cols number of columns, expected $ncols")
```

### 0.3 Fix Wrong Error Message Text
**File**: `src/main/groovy/se/alipsa/matrix/csv/CsvImporter.groovy`
**Line**: 320
**Issue**: Error message says "IgnoreEmptyLines" but should say "FirstRowAsHeader"

**Before**:
```groovy
throw new IllegalArgumentException("The value for FirstRowAsHeader must be a Boolean but was $val")
// But error text references wrong field in surrounding context
```

**After**: Verify error message text matches the field being validated

---

## Phase 1: Code Quality & DRY üü°

**Priority**: MEDIUM-HIGH
**Estimated Impact**: Reduced maintenance burden, cleaner codebase

### 1.1 Refactor CsvImporter Format Validation Logic
**File**: `src/main/groovy/se/alipsa/matrix/csv/CsvImporter.groovy`
**Lines**: 165-303 (138 lines of repetitive validation)
**Issue**: Highly repetitive pattern for Boolean/String/Enum validation repeated 10+ times

**Current Pattern** (repeated for Trim, IgnoreEmptyLines, IgnoreSurroundingSpaces, etc.):
```groovy
if (format.containsKey(Format.TRIM)) {
  def val = format.get(Format.TRIM)
  if (val instanceof Boolean) {
    f.setTrim(val as Boolean)
  } else {
    throw new IllegalArgumentException("The value for TRIM must be a Boolean but was $val")
  }
} else {
  f.setTrim(true)  // default
}
```

**Consolidation Strategy**:

Extract validation helpers:
```groovy
private static void setBoolean(CSVFormat.Builder builder, Map format, Format key,
                                boolean defaultValue, Closure setter) {
  if (format.containsKey(key)) {
    def val = format.get(key)
    if (!(val instanceof Boolean)) {
      throw new IllegalArgumentException("The value for ${key} must be a Boolean but was $val")
    }
    setter(builder, val as Boolean)
  } else {
    setter(builder, defaultValue)
  }
}

private static void setChar(CSVFormat.Builder builder, Map format, Format key,
                             Character defaultValue, Closure setter) {
  if (format.containsKey(key)) {
    def val = format.get(key)
    if (!(val instanceof String) || (val as String).length() != 1) {
      throw new IllegalArgumentException("The value for ${key} must be a single character but was $val")
    }
    setter(builder, (val as String).charAt(0))
  } else if (defaultValue != null) {
    setter(builder, defaultValue)
  }
}
```

**Expected Reduction**: 138 lines ‚Üí ~60 lines (58% reduction)

**Testing**: Run `./gradlew :matrix-csv:test` to ensure all format options still work

### 1.2 Eliminate CsvExporter File Handling Duplication
**File**: `src/main/groovy/se/alipsa/matrix/csv/CsvExporter.groovy`
**Lines**: 23-24, 43-44
**Issue**: Identical file handling code duplicated in two methods

**Current Duplication**:
```groovy
// Lines 23-24 (repeated in 43-44)
if (!out.parentFile.exists()) {
  out.parentFile.mkdirs()
}
if (out.isDirectory()) {
  out = new File(out, table.matrixName ?: 'matrix' + '.csv')
}
```

**Extracted Helper**:
```groovy
private static File ensureFileOutput(Matrix table, File out) {
  if (!out.parentFile.exists()) {
    out.parentFile.mkdirs()
  }
  if (out.isDirectory()) {
    return new File(out, table.matrixName ?: 'matrix.csv')
  }
  return out
}

static void exportToCsv(Matrix table, File out, boolean withHeader = true) {
  out = ensureFileOutput(table, out)
  exportToCsv(table, CSVFormat.DEFAULT, out, withHeader)
}
```

**Testing**: Run `./gradlew :matrix-csv:test --tests "CsvExporterTest"`

### 1.3 Add Input Validation to CsvExporter
**File**: `src/main/groovy/se/alipsa/matrix/csv/CsvExporter.groovy`
**Lines**: 22, 42, 75
**Issue**: No null checks for Matrix parameter, no validation for empty matrices

**Add Validation**:
```groovy
static void exportToCsv(Matrix table, File out, boolean withHeader = true) {
  if (table == null) {
    throw new IllegalArgumentException("Matrix table cannot be null")
  }
  if (table.rowCount() == 0 && table.columnCount() == 0) {
    throw new IllegalArgumentException("Cannot export empty matrix with no columns")
  }
  // ... rest of method
}
```

**Testing**: Add test cases for null and empty matrix inputs

---

## Phase 2: Test Coverage Expansion üîµ

**Priority**: MEDIUM
**Estimated Impact**: Increased confidence, regression prevention

### 2.1 Current Test Coverage Status
- **Test files**: 2
- **Test methods**: 4
- **Coverage estimate**: ~20-25% of functionality
- **Tested classes**: CsvImporter (basic import), CsvExporter (basic export)
- **Untested**: Most format options, input sources, edge cases

### 2.2 Testing Strategy

**Phase 2a: Critical Edge Cases** (Priority: HIGH)
1. **Empty/Edge Case Tests**
   - Create `CsvImportTest.testEmptyCsv()` - Empty CSV file
   - Create `CsvImportTest.testHeaderOnlyCsv()` - CSV with headers but no data
   - Create `CsvImportTest.testSingleColumnCsv()` - CSV with one column
   - Create `CsvImportTest.testSingleRowCsv()` - CSV with one data row
   - Create `CsvImportTest.testMismatchedColumns()` - Rows with different column counts

2. **Null/Invalid Input Tests**
   - Create `CsvImportTest.testNullInputValidation()` - Null format map, null sources
   - Create `CsvExporterTest.testNullMatrixValidation()` - Null matrix input
   - Create `CsvExporterTest.testEmptyMatrixValidation()` - Empty matrix

**Phase 2b: Format Options Coverage** (Priority: MEDIUM)
3. **CsvImporter Format Tests** (Currently only 3 of 14 Format values tested)
   - Test `CommentMarker` - Lines starting with comment character
   - Test `Escape` - Escape character handling
   - Test `NullString` - Custom null value representation
   - Test `RecordSeparator` - Custom line separator
   - Test `DuplicateHeaderMode` - Header collision handling
   - Test `FirstRowAsHeader=false` - Auto-generated column names ("c0", "c1", etc.)

4. **CsvImporter Input Sources** (Currently only URL tested)
   - Create `CsvImportTest.testImportFromFile()` - Direct File input
   - Create `CsvImportTest.testImportFromPath()` - Path input
   - Create `CsvImportTest.testImportFromInputStream()` - InputStream input
   - Create `CsvImportTest.testImportFromReader()` - Reader input
   - Create `CsvImportTest.testImportFromStringUrl()` - String URL input

**Phase 2c: CsvExporter Variations** (Priority: MEDIUM)
5. **Export Target Tests** (Currently only File and StringWriter tested)
   - Create `CsvExporterTest.testExportToPrintWriter()` - PrintWriter output
   - Create `CsvExporterTest.testExportToWriter()` - Writer output
   - Create `CsvExporterTest.testExportToCsvPrinter()` - CSVPrinter output
   - Create `CsvExporterTest.testExportToDirectory()` - Directory auto-creation
   - Create `CsvExporterTest.testExportWithoutHeader()` - withHeader=false

6. **Custom Format Tests**
   - Create `CsvExporterTest.testCustomDelimiter()` - Tab/semicolon delimiters
   - Create `CsvExporterTest.testCustomQuoteChar()` - Single quote instead of double

**Phase 2d: Integration & Round-Trip Tests** (Priority: LOW)
7. **Round-Trip Tests**
   - Create `CsvRoundTripTest.testDefaultFormat()` - Export then import with DEFAULT format
   - Create `CsvRoundTripTest.testCustomFormat()` - Export then import with custom format
   - Create `CsvRoundTripTest.testSpecialCharacters()` - Data with quotes, commas, newlines

**Overall Target**: 20+ test methods (5x current coverage)

---

## Phase 3: Documentation Improvements üìö

**Priority**: MEDIUM
**Estimated Impact**: Improved developer experience, API discoverability

### 3.1 Add GroovyDoc to CsvImporter
**File**: `src/main/groovy/se/alipsa/matrix/csv/CsvImporter.groovy`
**Issue**: Class and public methods lack GroovyDoc

**Required Documentation**:

1. **Class-level documentation** (before line 14):
```groovy
/**
 * Imports CSV files into Matrix objects using Apache Commons CSV.
 *
 * <p>Provides flexible CSV parsing with support for multiple input sources
 * (File, URL, InputStream, Reader) and configurable format options through
 * the {@link Format} enum.</p>
 *
 * <h3>Basic Usage</h3>
 * <pre>
 * // Simple import with default format
 * Matrix m = CsvImporter.importCsv(new File("data.csv"))
 *
 * // Custom format with semicolon delimiter
 * Matrix m = CsvImporter.importCsv([
 *   (Format.DELIMITER): ';',
 *   (Format.QUOTE): '"'
 * ], new File("data.csv"))
 * </pre>
 *
 * <h3>Format Options</h3>
 * <p>Use the {@link Format} enum to customize parsing behavior:</p>
 * <ul>
 *   <li><b>DELIMITER</b> - Field separator (default: comma)</li>
 *   <li><b>QUOTE</b> - Quote character (default: double quote)</li>
 *   <li><b>ESCAPE</b> - Escape character for special characters</li>
 *   <li><b>TRIM</b> - Trim whitespace from values (default: true)</li>
 *   <li><b>FirstRowAsHeader</b> - Use first row as column names (default: true)</li>
 * </ul>
 *
 * @see CsvExporter
 * @see Format
 */
@CompileStatic
class CsvImporter {
```

2. **Method documentation** for all 6 public methods (lines 34-62):
```groovy
/**
 * Import a CSV file with custom format options.
 *
 * @param format Map of format options using {@link Format} enum keys
 * @param url URL pointing to the CSV file to import
 * @return Matrix containing the imported data
 * @throws IOException if reading the URL fails
 * @throws IllegalArgumentException if format options are invalid
 */
static Matrix importCsv(Map<Format, Object> format, URL url) throws IOException {
```

3. **Format enum documentation** (lines 17-32):
```groovy
/**
 * Configuration options for CSV parsing.
 *
 * <p>These enum values are used as keys in the format Map passed to
 * {@link #importCsv(Map, URL)} and related methods.</p>
 */
private enum Format {
  /** Field delimiter character (default: comma) */
  DELIMITER,
  /** Quote character for enclosing fields (default: double quote) */
  QUOTE,
  // ... etc
}
```

### 3.2 Enhance README with Error Handling Examples
**File**: `README.md`
**Issue**: No examples of exception handling or edge case behavior

**Add Section**:
```markdown
## Error Handling

The CSV module throws exceptions for invalid inputs:

```groovy
try {
  Matrix m = CsvImporter.importCsv(new File("data.csv"))
} catch (IOException e) {
  // File not found or read error
} catch (IllegalArgumentException e) {
  // Invalid format options or mismatched columns
}
```

## Edge Cases

**Empty CSV Files**: Returns an empty Matrix with no columns
**Header-only CSV**: Returns a Matrix with column names but zero rows
**Mismatched Columns**: Throws IllegalArgumentException if rows have different column counts
```

### 3.3 Document Format Enum Values
**File**: `README.md` or create `FORMAT_OPTIONS.md`

Add complete reference table:

| Format Option | Type | Default | Description |
|---------------|------|---------|-------------|
| DELIMITER | Character | ',' | Field separator character |
| QUOTE | Character | '"' | Character used to enclose fields |
| ESCAPE | Character | null | Character used to escape special characters |
| COMMENT_MARKER | Character | null | Lines starting with this character are ignored |
| TRIM | Boolean | true | Trim whitespace from field values |
| ... | ... | ... | ... |

---

## Phase 4: API Enhancements üü¢

**Priority**: LOW
**Estimated Impact**: Improved developer experience (non-breaking)

### 4.1 Add Convenience Methods
**File**: `src/main/groovy/se/alipsa/matrix/csv/CsvImporter.groovy`

**Suggestion 1: Add String path support**
```groovy
static Matrix importCsv(String filePath) throws IOException {
  importCsv(new File(filePath))
}
```

**Suggestion 2: Add Builder pattern alternative**
```groovy
class CsvImportBuilder {
  private CSVFormat.Builder builder = CSVFormat.DEFAULT.builder()
  private boolean firstRowAsHeader = true
  private Charset charset = StandardCharsets.UTF_8

  CsvImportBuilder delimiter(char c) { builder.setDelimiter(c); this }
  CsvImportBuilder quote(char c) { builder.setQuote(c); this }
  CsvImportBuilder trim(boolean b) { builder.setTrim(b); this }

  Matrix from(File file) { /* ... */ }
  Matrix from(URL url) { /* ... */ }
}

// Usage:
Matrix m = CsvImporter.builder()
  .delimiter(';')
  .quote('"')
  .trim(true)
  .from(new File("data.csv"))
```

### 4.2 Consider Charset Auto-Detection
**File**: `src/main/groovy/se/alipsa/matrix/csv/CsvImporter.groovy`
**Enhancement**: Add BOM (Byte Order Mark) detection for UTF-8/UTF-16/UTF-32 files

### 4.3 Add Export Format Presets
**File**: `src/main/groovy/se/alipsa/matrix/csv/CsvExporter.groovy`

**Add Common Formats**:
```groovy
// Microsoft Excel format
static void exportToExcelCsv(Matrix table, File out, boolean withHeader = true) {
  exportToCsv(table, CSVFormat.EXCEL, out, withHeader)
}

// Tab-separated values
static void exportToTsv(Matrix table, File out, boolean withHeader = true) {
  exportToCsv(table, CSVFormat.TDF, out, withHeader)
}
```

---

## Implementation Checklist

### Phase 0: Critical Bug Fixes ‚úÖ
- [ ] 0.1 Fix IndexOutOfBoundsException on empty CSV
  - [ ] Add empty check before accessing rows[0]
  - [ ] Return empty Matrix with proper structure
  - [ ] Add test for empty CSV file
  - [ ] Add test for header-only CSV
- [ ] 0.2 Fix typo "extected" ‚Üí "expected" (line 119)
- [ ] 0.3 Fix wrong error message at line 320
- [ ] Run `./gradlew :matrix-csv:test`

### Phase 1: Code Quality & DRY
- [ ] 1.1 Refactor format validation logic
  - [ ] Extract `setBoolean()` helper method
  - [ ] Extract `setChar()` helper method
  - [ ] Extract `setString()` helper method
  - [ ] Refactor all 10+ validation blocks
  - [ ] Verify reduction from 138 lines to ~60 lines
  - [ ] Run `./gradlew :matrix-csv:test`
- [ ] 1.2 Eliminate file handling duplication
  - [ ] Extract `ensureFileOutput()` helper
  - [ ] Update both exportToCsv methods
  - [ ] Run `./gradlew :matrix-csv:test --tests "CsvExporterTest"`
- [ ] 1.3 Add input validation to CsvExporter
  - [ ] Add null check for Matrix parameter
  - [ ] Add empty matrix validation
  - [ ] Add test cases

### Phase 2: Test Coverage Expansion
**Phase 2a: Critical Edge Cases**
- [ ] 2a.1 Create `testEmptyCsv()` - Empty file
- [ ] 2a.2 Create `testHeaderOnlyCsv()` - Headers but no data
- [ ] 2a.3 Create `testSingleColumnCsv()` - One column
- [ ] 2a.4 Create `testSingleRowCsv()` - One data row
- [ ] 2a.5 Create `testMismatchedColumns()` - Different column counts
- [ ] 2a.6 Create `testNullInputValidation()` - Null checks
- [ ] 2a.7 Create `testNullMatrixValidation()` - Exporter null check
- [ ] 2a.8 Create `testEmptyMatrixValidation()` - Empty matrix

**Phase 2b: Format Options Coverage**
- [ ] 2b.1 Test CommentMarker format option
- [ ] 2b.2 Test Escape character handling
- [ ] 2b.3 Test NullString representation
- [ ] 2b.4 Test RecordSeparator
- [ ] 2b.5 Test DuplicateHeaderMode
- [ ] 2b.6 Test FirstRowAsHeader=false with auto-generated names

**Phase 2c: Input Sources & Export Targets**
- [ ] 2c.1 Test import from File directly
- [ ] 2c.2 Test import from Path
- [ ] 2c.3 Test import from InputStream
- [ ] 2c.4 Test import from Reader
- [ ] 2c.5 Test export to PrintWriter
- [ ] 2c.6 Test export to directory with auto-creation
- [ ] 2c.7 Test export with withHeader=false

**Overall Progress**:
- Current tests: 4
- Target tests: 20+
- Run `./gradlew :matrix-csv:test`

### Phase 3: Documentation Improvements
- [ ] 3.1 Add GroovyDoc to CsvImporter
  - [ ] Add class-level documentation
  - [ ] Document all 6 public methods
  - [ ] Document Format enum and members
  - [ ] Document private helper methods
- [ ] 3.2 Enhance README
  - [ ] Add error handling section
  - [ ] Add edge cases section
  - [ ] Add examples for all format options
- [ ] 3.3 Create format options reference
  - [ ] Document all 14 Format enum values
  - [ ] Create table with types and defaults

### Phase 4: API Enhancements (Optional)
- [ ] 4.1 Add convenience methods
  - [ ] String path support
  - [ ] Builder pattern alternative
- [ ] 4.2 Charset auto-detection
- [ ] 4.3 Export format presets

---

## Success Criteria

### v2.2.2 Release Requirements
- [ ] Empty CSV file handling implemented (no crash)
- [ ] Typos in error messages fixed
- [ ] All existing tests passing: `./gradlew :matrix-csv:test`
- [ ] Test coverage increased from 4 to 12+ tests (3x increase minimum)
- [ ] GroovyDoc added to CsvImporter class and public methods
- [ ] No deprecation warnings
- [ ] Format validation code reduced by 50%+ (138 lines ‚Üí ~60 lines)

### v2.3.0 Targets (Future)
- [ ] Test coverage 20+ tests (comprehensive)
- [ ] Builder pattern API available
- [ ] Complete format options documentation
- [ ] Round-trip tests implemented

---

## Notes

### Breaking Changes
**None in v2.2.2** - All changes are internal improvements or additions.

**Potential for v2.3.0**:
- Builder pattern may deprecate Map-based format API
- Charset auto-detection might change default behavior

### Dependencies
- Current: Apache Commons CSV 1.14.1 (already used)
- No new dependencies required

### Performance Considerations
- Format validation refactoring should have no performance impact
- Empty CSV handling adds minimal overhead (one `isEmpty()` check)
- @CompileStatic already enabled for performance

### Documentation Updates Needed
- Generate GroovyDoc after Phase 3 completion
- Update README with all new examples
- Consider creating wiki pages for advanced usage

---

## Review History

| Date | Reviewer | Version | Notes |
|------|----------|---------|-------|
| 2026-01-22 | Claude Code Agent | 2.2.1 | Initial roadmap creation based on comprehensive module analysis. Identified critical crash bug (empty CSV), significant code duplication (format validation), very low test coverage (4 tests only), and documentation gaps (CsvImporter lacks GroovyDoc). Prioritized into 4 phases: Phase 0 (critical bugs), Phase 1 (code quality/DRY), Phase 2 (test coverage expansion 4‚Üí20+ tests), Phase 3 (documentation), Phase 4 (API enhancements). |
