# Matrix Spreadsheet v2.3.0 Release Roadmap

This document outlines the remaining work needed to make matrix-spreadsheet v2.3.0 production ready.

## Summary

The module has been significantly refactored in the lead-up to v2.3.0:
- Removed legacy POI and SODS dependencies
- Consolidated on FastExcel (for .xlsx) and internal FastOds (for .ods)
- Added append/replace capabilities for existing files
- Added flexible start positions when writing data
- Hardened XML parsing with XXE protection

All v2.3.0 scoped items are complete. Remaining work has been deferred to v2.4.0.

---

## Priority 1: Bug Fixes (Must Fix)

### 1.1 [x] Fix missing return statement in ValueExtractor.getDouble()
- **File**: `src/main/groovy/se/alipsa/matrix/spreadsheet/ValueExtractor.groovy`
- **Line**: 25
- **Issue**: The result of `percentFormat.parse(strVal).doubleValue()` is calculated but not returned
- **Impact**: Silently returns `null` instead of the parsed percentage value
- **Fix**: Added `return` before `percentFormat.parse(strVal).doubleValue()`
- **Test command**: `./gradlew :matrix-spreadsheet:test`

### 1.2 [x] Remove System.err.println() from FExcelExporter
- **File**: `src/main/groovy/se/alipsa/matrix/spreadsheet/fastexcel/FExcelExporter.groovy`
- **Issue**: Debug statement `System.err.println("Not yet implemented")` in production code
- **Fix**: Removed the entire `upsertSheet` method and associated dead code (append is handled by `FExcelAppender`)
- **Test command**: `./gradlew :matrix-spreadsheet:test`

### 1.3 [x] Remove println from FOdsImporter
- **File**: `src/main/groovy/se/alipsa/matrix/spreadsheet/fastods/FOdsImporter.groovy`
- **Issue**: Production code uses `println` instead of proper logging
- **Fix**: Replaced with `logger.warn()` and added Logger field
- **Test command**: `./gradlew :matrix-spreadsheet:test`

### 1.4 [x] Handle invalid sheet numbers in FExcelImporter URL imports
- **File**: `src/main/groovy/se/alipsa/matrix/spreadsheet/fastexcel/FExcelImporter.groovy`
- **Location**: `importSpreadsheet(URL url, int sheetNumber, ...)`
- **Issue**: Uses `workbook.getSheet(sheetNumber - 1).orElse(null)` and passes `null` into `importExcelSheet`, which then NPEs
- **Fix**: Added `sheetNumber >= 1` validation and changed to `orElseThrow()`, consistent with file-based overloads
- **Test command**: `./gradlew :matrix-spreadsheet:test`

### 1.5 [x] Guard against null rows in FExcelReader.findColNum
- **File**: `src/main/groovy/se/alipsa/matrix/spreadsheet/fastexcel/FExcelReader.groovy`
- **Location**: `findColNum(Sheet sheet, int rowNumber, String content)`
- **Issue**: `FExcelUtil.getRow(...)` can return `null`; `row.cellCount` then throws NPE
- **Fix**: Added null check for row, returns `-1` when the row is missing. Also removed unreachable dead code and fixed resource leak in `findLastCol`.
- **Test command**: `./gradlew :matrix-spreadsheet:test`

### 1.6 [x] Prevent sheet-name collisions after sanitization (data loss risk)
- **Files affected**:
  - `src/main/groovy/se/alipsa/matrix/spreadsheet/SpreadsheetUtil.groovy`
  - `src/main/groovy/se/alipsa/matrix/spreadsheet/SpreadsheetWriteUtil.groovy`
  - `src/main/groovy/se/alipsa/matrix/spreadsheet/fastexcel/FExcelAppender.groovy`
  - `src/main/groovy/se/alipsa/matrix/spreadsheet/fastods/FOdsAppender.groovy`
  - `src/main/groovy/se/alipsa/matrix/spreadsheet/fastods/FOdsExporter.groovy`
- **Issue**: `createValidSheetName` can make two different names identical (e.g., `A/B` and `A?B` → `A B`), causing map overwrites and silent sheet loss
- **Fix**: Added `createUniqueSheetNames()` method that de-duplicates sanitized names by appending numeric suffixes. Updated all callers to use it.
- **Test command**: `./gradlew :matrix-spreadsheet:test`

### 1.7 [x] Validate/sanitize sheetNames in FExcelExporter.exportExcelSheets
- **File**: `src/main/groovy/se/alipsa/matrix/spreadsheet/fastexcel/FExcelExporter.groovy`
- **Location**: `exportExcelSheets(File file, List<Matrix> data, List<String> sheetNames, ...)`
- **Issue**: Does not verify `sheetNames.size() == data.size()` and does not sanitize or de-duplicate names
- **Fix**: Added list size validation and now uses `createUniqueSheetNames` for collision handling
- **Test command**: `./gradlew :matrix-spreadsheet:test`

---

## Priority 2: Code Quality (Should Fix)

### 2.1 [x] Clean up dead code in FExcelExporter
- **File**: `src/main/groovy/se/alipsa/matrix/spreadsheet/fastexcel/FExcelExporter.groovy`
- **Issue**: Exception thrown followed by commented-out TODO code and unused writeFile method
- **Fix**: Removed the `upsertSheet` method entirely (append is handled by `FExcelAppender` now), removed commented TODO code, and removed the unused commented `writeFile` method
- **Test command**: `./gradlew :matrix-spreadsheet:test`

### 2.2 [x] Remove commented debug print statements
- **Files affected**:
  - `SpreadsheetImporter.groovy`
  - `FExcelReader.groovy`
  - `FExcelValueExtractor.groovy`
  - `FExcelImporter.groovy`
  - `FOdsImporter.groovy`
- **Count**: ~15 commented println statements removed
- **Fix**: Removed all commented `//println` statements
- **Test command**: `./gradlew :matrix-spreadsheet:test`

### 2.3 [x] Update deprecation notice in SpreadsheetExporter
- **File**: `src/main/groovy/se/alipsa/matrix/spreadsheet/SpreadsheetExporter.groovy`
- **Issue**: States "This class will be removed in v2.0" but we're at v2.3.0
- **Fix**: Updated to "This class will be removed in v3.0"
- **Test command**: `./gradlew :matrix-spreadsheet:test`

### 2.4 [x] Close ReadableWorkbook and handle missing row in FExcelUtil.getFormat
- **File**: `src/main/groovy/se/alipsa/matrix/spreadsheet/fastexcel/FExcelUtil.groovy`
- **Issue**: `ReadableWorkbook` is not closed and `row` can be null (NPE on `row.getCell`)
- **Fix**: Added try-with-resources for the workbook and stream, added null check for row
- **Test command**: `./gradlew :matrix-spreadsheet:test`

### 2.5 [x] Make FExcelValueExtractor.getLocalDateTime null-safe
- **File**: `src/main/groovy/se/alipsa/matrix/spreadsheet/fastexcel/FExcelValueExtractor.groovy`
- **Issue**: Empty cells lead to `LocalDateTime.parse("null")` and a `DateTimeParseException`
- **Fix**: Added null checks - return `null` when the cell, row, or extracted value is null
- **Test command**: `./gradlew :matrix-spreadsheet:test`

### 2.6 [x] Align empty-sheet behavior between ODS and Excel importers
- **File**: `src/main/groovy/se/alipsa/matrix/spreadsheet/fastods/FOdsImporter.groovy`
- **Issue**: Empty ODS sheet returns `null` while Excel importers return a Matrix; behavior is inconsistent
- **Fix**: Changed FOdsImporter to return an empty Matrix (with empty column names and rows) instead of null, aligning with Excel importer behavior
- **Test command**: `./gradlew :matrix-spreadsheet:test`

### 2.7 [x] Close sheet stream in FExcelReader.findLastCol
- **File**: `src/main/groovy/se/alipsa/matrix/spreadsheet/fastexcel/FExcelReader.groovy`
- **Issue**: `sheet.openStream()` is not closed in `findLastCol`, which may leak resources
- **Fix**: Wrapped in try-with-resources
- **Test command**: `./gradlew :matrix-spreadsheet:test`

---

## Priority 3: Documentation (Recommended)

### 3.1 [x] Update README.md version numbers
- **File**: `README.md`
- **Lines**: 12-34
- **Issue**: Example dependency versions are outdated (shows 2.2.1, should be 2.3.0 after release)
- **Fix**: Updated Groovy to 5.0.3, matrix-spreadsheet to 2.3.0
- **Test command**: `./gradlew :matrix-spreadsheet:test`

### 3.2 [x] Update version compatibility matrix in README
- **File**: `README.md`
- **Lines**: 156-171
- **Issue**: Missing v2.3.0 entry; some duplicate entries exist
- **Fix**: Added 2.3.0 row, removed duplicate entries, fixed description text
- **Test command**: `./gradlew :matrix-spreadsheet:test`

### 3.3 [x] Add GroovyDoc to OdsStreamDataReader
- **File**: `src/main/groovy/se/alipsa/matrix/spreadsheet/fastods/reader/OdsStreamDataReader.groovy`
- **Issue**: Complex trailing-empty-row handling logic (TRAILING_EMPTY_ROW_THRESHOLD = 1000) lacks explanation
- **Fix**: Added comprehensive class-level GroovyDoc explaining the threshold behavior, why it exists, and its implications
- **Test command**: `./gradlew :matrix-spreadsheet:test`

### 3.4 [x] Document the regex limitation in FExcelAppender
- **File**: `src/main/groovy/se/alipsa/matrix/spreadsheet/fastexcel/FExcelAppender.groovy`
- **Issue**: Comment acknowledges limitation but could be clearer
- **Fix**: Added detailed GroovyDoc to `readSheetFormatAttributesFallback` and `extractElementXml` methods explaining limitations (double-quoted attrs only, no nested elements, etc.)
- **Test command**: `./gradlew :matrix-spreadsheet:test`

---

## Priority 4: Testing Improvements (Nice to Have)

### 4.1 [x] Add test for ValueExtractor percentage parsing
- **Issue**: The bug in 1.1 exists because there's no test for percentage-formatted cells
- **Fix**: Created new ValueExtractorTest.groovy with comprehensive tests for getDouble (including percentage), getInt, getLong, getBoolean, getString
- **Test command**: `./gradlew :matrix-spreadsheet:test`

### 4.2 [x] Add edge case tests
- **Tests added**:
  - Single-cell spreadsheet (SpreadsheetWriterTest.testSingleCellMatrix)
  - Maximum sheet name length (SpreadsheetWriterTest.testMaxSheetNameLength)
  - Invalid cell references (SpreadSheetUtilTest.testParseCellPositionInvalid)
  - Sheet name sanitization (SpreadSheetUtilTest.testCreateValidSheetName)
- **Test command**: `./gradlew :matrix-spreadsheet:test`

### 4.3 [x] Add test for ODS trailing-empty-rows threshold
- **Test**: Already existed in SpreadsheetWriterTest.testOdsStopsAtTrailingEmptyRows
- Verified working correctly

### 4.4 [x] Add tests for sheet-name sanitization collisions
- **Tests added**:
  - SpreadSheetUtilTest.testCreateUniqueSheetNames (unit test for collision handling)
  - SpreadSheetUtilTest.testCreateUniqueSheetNamesMaxLength (31-char limit with suffix)
  - SpreadsheetWriterTest.testSheetNameCollisionHandlingXlsx (integration test)
  - SpreadsheetWriterTest.testSheetNameCollisionHandlingOds (integration test)
- **Test command**: `./gradlew :matrix-spreadsheet:test`

### 4.5 [x] Add tests for invalid sheet/row lookups
- **Tests added**:
  - FExcelImporterTest.testInvalidSheetNumberThrows (sheet 0, -1, 999)
  - FExcelImporterTest.testInvalidSheetNameThrows
  - FExcelImporterTest.testNullUrlThrows
  - FOdsImporterTest.testInvalidSheetNumberThrows
  - FOdsImporterTest.testInvalidSheetNameThrows
  - SpreadsheetReaderTest.testFindColNumInNonExistentRow
  - SpreadsheetReaderTest.testFindRowNumContentNotFound
  - SpreadsheetReaderTest.testFindColNumContentNotFound
- **Test command**: `./gradlew :matrix-spreadsheet:test`

---

## Priority 5: Coverage & Performance Targets

### 5.1 [ ] Coverage target (>= 70%)
- Current line coverage: **79.74%** (1421 covered / 361 missed)
- Target: maintain **>= 70%** line coverage for matrix-spreadsheet
- Report location: `matrix-spreadsheet/build/reports/jacoco/test/html/index.html`

### 5.2 [ ] Benchmark targets (ODS vs Excel)
- 50k x 12 benchmark (rows=50k, cols=12):
  - XLSX read avg ~0.85s, ODS read avg ~6.89s (ODS ~8.1x slower)
  - XLSX write avg ~2.14s, ODS write avg ~1.40s (ODS faster)
- Large file (Crime_Data_from_2023):
  - XLSX read ~26s, ODS read ~4m22s (ODS ~10.1x slower)
- Target: reduce ODS read to **< 2x slower** than XLSX on representative datasets

---

## Priority 6: Test Coverage & Performance Plan (Target >= 70%)

### 6.1 [x] Add coverage tooling and baseline report (matrix-spreadsheet)
- Added JaCoCo config for `:matrix-spreadsheet:test` with a LINE coverage gate (>= 70%)
- Baseline line coverage: **79.74%** (1421 covered / 361 missed)
- Report location: `matrix-spreadsheet/build/reports/jacoco/test/html/index.html`
- **Test command**: `./gradlew :matrix-spreadsheet:jacocoTestCoverageVerification --rerun-tasks`

### 6.2 [x] Identify low-coverage areas and add tests
- Baseline already meets target (>= 70% line coverage), so no additional tests required to meet the threshold
- **Test command**: `./gradlew :matrix-spreadsheet:jacocoTestCoverageVerification --rerun-tasks`

### 6.3 [x] Add performance benchmarks for XLSX/ODS read/write
- Added `SpreadsheetBenchmark` runner and Gradle task `:matrix-spreadsheet:spreadsheetBenchmark`
- Baseline (rows=50k, cols=12): XLSX write ~1.84s, read ~0.88s; ODS write ~1.13s, read ~4.86s
- **Test command**: `./gradlew :matrix-spreadsheet:spreadsheetBenchmark --rerun-tasks`

### 6.4 [x] Run benchmarks and analyze results
- ODS read is significantly slower than XLSX; write is comparable or faster for ODS at this scale
- Large-file baseline (Crime_Data_from_2023): ODS read ~3m21s vs XLSX ~23s
- **Test command**: `./gradlew :matrix-spreadsheet:test -PrunSlowTests=true --tests "spreadsheet.LargeFileImportTest" --rerun-tasks`

### 6.5 [x] Fix performance issues and document improvements
- Optimized ODS stream reader to skip expensive empty-row checks unless needed and avoid per-cell loops when repeated columns fall outside the requested range
- Added ODS profiling toggle (`-PodsProfile=true`) to capture row/extractValue timing and cell counts
- Profiling highlights: `processRow` dominates (~6.3s) vs `extractValue` (~1.3–1.6s) on 50k x 12 benchmark
- Large-file ODS read improved from ~4m46s → ~4m39s (avoid per-row list copies when `repeatRows == 1`) → ~4m22s (skip remaining cells after `endColumn`)
- **Files**: `src/main/groovy/se/alipsa/matrix/spreadsheet/fastods/reader/OdsStreamDataReader.groovy`
- **Test command**: `./gradlew :matrix-spreadsheet:spreadsheetBenchmark --rerun-tasks`

---

## Verification Checklist

Before releasing v2.3.0:

- [x] All tests pass: `./gradlew :matrix-spreadsheet:test`
- [x] Slow tests pass: `./gradlew :matrix-spreadsheet:test -PrunSlowTests=true`
- [x] Build succeeds: `./gradlew :matrix-spreadsheet:build`
- [x] GroovyDoc generates without errors (via antGroovydoc task in build)
- [x] No compiler warnings (deprecation warnings are acceptable)
- [x] README version numbers updated
- [ ] SNAPSHOT suffix removed from build.gradle version (moved to v2.4.0 release checklist)

---

## Test Commands

```bash
# Run all module tests
./gradlew :matrix-spreadsheet:test

# Run including slow tests
./gradlew :matrix-spreadsheet:test -PrunSlowTests=true

# Build module
./gradlew :matrix-spreadsheet:build

# Generate documentation
./gradlew :matrix-spreadsheet:antGroovydoc
```

---

## Module Statistics

- **Source files**: 33 (.groovy and .java)
- **Test classes**: 15 (added ValueExtractorTest)
- **Test count**: 105 tests (increased from 78)
- **Direct dependencies**: FastExcel 0.19.0, log4j-api
- **Removed dependencies**: POI 5.5.1, SODS 1.7.0

---

## Recent Improvements (Already Done)

The following improvements were completed in preparation for v2.3.0:

- [x] Simplified backends (removed POI 5.5.1, removed SODS 1.7.0)
- [x] Added append/replace support for .xlsx (FExcelAppender)
- [x] Added append/replace support for .ods (FOdsAppender)
- [x] New ODS streaming writer with base template reuse
- [x] XLSX append now inherits sheetFormatPr, column widths, page margins
- [x] Explicitly reject legacy .xls (only .xlsx supported)
- [x] Updated tests for append/replace scenarios
- [x] Hardened XML parsing: namespace-aware DOM, safer attr regex, null-safe operations
- [x] Trailing-empty-rows optimization in ODS reader
- [x] Centralized validation in SpreadsheetUtil.ensureXlsx()

---

## Fixes Applied (2026-01-25)

All Priority 1 bug fixes and most Priority 2 code quality improvements have been completed:

### Priority 1 (All Complete)
- 1.1 ValueExtractor.getDouble() missing return - Fixed
- 1.2 FExcelExporter debug println - Removed dead code entirely
- 1.3 FOdsImporter println - Replaced with logger.warn()
- 1.4 FExcelImporter URL sheet validation - Added validation and orElseThrow()
- 1.5 FExcelReader.findColNum null row - Added null guard
- 1.6 Sheet-name collision handling - Added createUniqueSheetNames() utility
- 1.7 FExcelExporter sheetNames validation - Added size validation and collision handling

### Priority 2 (All Complete)
- 2.1 Dead code cleanup - Removed upsertSheet, writeFile, and commented TODOs
- 2.2 Commented printlns - Removed ~15 statements from 5 files
- 2.3 Deprecation notice - Updated to v3.0
- 2.4 FExcelUtil resource leak - Added try-with-resources
- 2.5 getLocalDateTime null-safety - Added null checks
- 2.6 Empty-sheet behavior alignment - ODS now returns empty Matrix instead of null
- 2.7 findLastCol stream leak - Added try-with-resources

### Priority 3 (All Complete)
- 3.1 README version numbers - Updated to 2.3.0, Groovy 5.0.3
- 3.2 Version compatibility matrix - Added 2.3.0, removed duplicates
- 3.3 OdsStreamDataReader GroovyDoc - Documented trailing-empty-row threshold behavior
- 3.4 FExcelAppender regex docs - Documented limitations of fallback regex parsers

### Priority 4 (All Complete)
- 4.1 ValueExtractor percentage test - Created ValueExtractorTest.groovy with comprehensive tests
- 4.2 Edge case tests - Added single-cell, max name length, invalid cell refs, sanitization tests
- 4.3 Trailing-empty-rows test - Already exists and verified working
- 4.4 Sheet-name collision tests - Added unit and integration tests for XLSX and ODS
- 4.5 Invalid sheet/row lookup tests - Added tests for both FExcelImporter and FOdsImporter
