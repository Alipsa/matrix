# Matrix Stats v2.4.0 Release Roadmap

This document outlines the planned work for adding a FormulaEvaluator to matrix-stats.

## Summary

v2.4.0 introduces a general formula evaluator to power richer model formulas and
support multiple smoothing methods (lm, loess, gam) for downstream consumers
(e.g. matrix-charts).

---

## Priority 1: FormulaEvaluator Core (Must Do)

### 1.1 [ ] Define formula grammar and public API
- Document supported syntax (response ~ terms, +, -, :, *, intercept control)
- Specify built-in transforms (e.g., log(), sqrt(), exp(), poly(x, n), I(...))
- Define API shape (e.g., FormulaEvaluator.evaluate(data, formula, options))

### 1.2 [ ] Implement tokenizer and parser to AST
- Create token types and an AST model for terms, transforms, interactions
- Ensure clear error messages for invalid formulas

### 1.3 [ ] Build design matrix from AST
- Map variables to data columns
- Handle intercept, interactions, and polynomial terms
- Decide handling of categorical terms (one-hot or error) and document it

### 1.4 [ ] Define FitResult / ModelResult output
- Standardize outputs: fitted values, optional se bands, residuals, diagnostics
- Keep output consistent across methods (lm, loess, gam)

---

## Priority 2: Smoothing/Model Methods (Must Do)

### 2.1 [ ] Add method registry and interface
- Define a FitMethod interface and registry keyed by method name (lm, loess, gam)
- Validate method-specific parameters (span, degree, family, etc.)

### 2.2 [ ] Implement lm adapter using existing regressions
- Use LinearRegression/PolynomialRegression via the design matrix
- Support formulas that expand beyond simple poly degree

### 2.3 [ ] Implement loess
- Implement local regression with span and degree support
- Reuse existing `LinearRegression` or `PolynomialRegression` for local fits with weighted observations
- Implement tricube weight function for neighbour weighting
- Return fitted values and optional standard errors
  For LOESS without commons-math3, you can reuse existing regression classes:

```groovy
  class LoessRegression {
    // Reuse existing LinearRegression for degree=1 local fits                                      
    // or PolynomialRegression for degree=2                                                                   
    BigDecimal predict(Number x, List<Number> xData, List<Number> yData, BigDecimal span, int degree) {            
      // 1. Find neighbors within span
        int k = (span * xData.size()).intValue()
        def neighbors = findKNearestNeighbors(x, xData, yData, k)
        // 2. Calculate tricube weights based on distance
        def weights = calculateTricubeWeights(x, neighbors.x)
        // 3. Fit weighted regression using existing classes
        // LinearRegression already computes via normal equations
        // Could add weighted version or use weighted observations
        def localFit = degree == 1 ? new WeightedLinearRegression(neighbors.x, neighbors.y, weights) : new WeightedPolynomialRegression(neighbors.x, neighbors.y, weights, degree)
        return localFit.predict(x)                                                       
      }                                                                                  
  }
```
  The key reusable components from existing code:
  - Normal equations computation pattern from LinearRegression
  - Polynomial evaluation (Horner's method) from PolynomialRegression
  - RÂ² calculation pattern
  - Prediction API design

### 2.4 [ ] Implement gam
- Choose implementation strategy (spline basis or dependency)
- Add smooth term support (e.g., s(x)) or document minimal subset

---

## Priority 3: Tests, Docs, and Validation (Must Do)

### 3.1 [ ] Parser and AST tests
- Valid formulas, invalid syntax, edge cases

### 3.2 [ ] Evaluator tests
- Design matrix correctness for transforms and interactions
- Consistent results across lm/loess/gam for known datasets

### 3.3 [ ] GroovyDoc and README updates
- Document formula syntax, supported methods, and limitations

### 3.4 [ ] Run matrix-stats tests
- Command: `./gradlew :matrix-stats:test`

---

## Priority 4: Remove commons-math3 Dependency (Should Do)

Apache Commons Math3 is deprecated and should be replaced with native implementations or alternative libraries. Current usage:

### 4.1 [ ] Replace distribution classes
- ChiSquaredDistribution, NormalDistribution, FDistribution, HypergeometricDistribution
- Used in: Ellipse, Fisher, ChiSquared, CochranArmitage, TurningPoint, Chow, Granger, CochranMantelHaenszel, Portmanteau, Lilliefors, KSquared, JarqueBera, KolmogorovSmirnov, ShapiroWilk, AndersonDarling, ShapiroFrancia, CramerVonMises
- Options: Implement CDF/PDF functions natively or use Smile's distributions (already a dependency in matrix-smile)

### 4.2 [ ] Replace linear algebra classes
- Array2DRowRealMatrix, LUDecomposition, RealMatrix
- Used in: RegressionUtils, Johansen
- Options: Implement using Grid operations or use EJML library

### 4.3 [ ] Replace optimisation/solver classes
- PolynomialCurveFitter, SimplexOptimizer, NelderMeadSimplex, BrentSolver
- Used in: PolynomialRegression, LogisticRegression, QuantileRegression, GoalSeek
- Options: Implement polynomial fitting using normal equations, implement simplex natively

### 4.4 [ ] Replace statistical utilities
- OLSMultipleLinearRegression, KolmogorovSmirnovTest, StatUtils
- Used in: Adf, KolmogorovSmirnov, ShapiroWilk, ShapiroFrancia
- Options: Extend existing LinearRegression for multiple regression, implement tests natively

### 4.5 [ ] Move commons-math3 to testImplementation only
- Keep for test validation/comparison if needed
- Remove from runtime dependencies

---

## Open Questions

### 5.1 [ ] Decide categorical handling strategy
- One-hot encoding vs. explicit error until categorical support is added

### 5.2 [ ] Decide gam implementation dependency
- Evaluate whether to implement internally or adopt a library
