# Matrix Stats v2.4.0 Release Roadmap

This document outlines the planned work for adding a FormulaEvaluator to matrix-stats.

## Summary

v2.4.0 introduces a general formula evaluator aligned with R-style formulas to power
richer model specifications, consistent model frames, and multiple smoothing methods
(lm, loess, gam) for downstream consumers (e.g. matrix-charts).

---

## Priority 1: Formula Grammar and Parsing (Must Do)

### 1.1 [ ] Define formula grammar and public API
- Supported syntax: response ~ terms, +, -, :, *, intercept control (0/1/-1)
- R-style operators: dot expansion (.), interaction expansion (^), nesting (/)
- Parentheses grouping and backtick-quoted column names
- Built-in transforms: log(), sqrt(), exp(), poly(x, n), I(...)
- Multi-response policy (explicitly supported or explicitly rejected)

### 1.2 [ ] Implement tokenizer and parser to AST
- Token types for operators, identifiers, function calls, literals, backticks
- AST nodes for terms, transforms, interactions, and grouping
- Clear error messages with location context

### 1.3 [ ] Implement formula update and normalization helpers
- Provide utilities for defaulting to `y ~ x` when appropriate
- Normalize equivalent formulas to a consistent internal form

---

## Priority 2: Model Frame Evaluation (Must Do)

### 2.1 [ ] Build a ModelFrame pipeline
- Resolve variables from data (data-first evaluation)
- Optional explicit environment resolution hook (if needed later)
- Support dot expansion and exclusion (-) before matrix building

### 2.2 [ ] Support weights, offset, subset, and na.action
- weights: numeric vector aligned to rows
- offset: numeric vector applied to fitted values
- subset: row filter expression or boolean mask
- na.action: omit/fail/exclude behavior

---

## Priority 3: Design Matrix and Categorical Handling (Must Do)

### 3.1 [ ] Implement design matrix builder from AST
- Intercept handling, interactions, polynomial terms
- Preserve column name mapping for downstream diagnostics

### 3.2 [ ] Add categorical handling and contrasts
- Factor detection and consistent encoding policy
- Default contrasts (treatment) with opt-in alternatives
- Interactions involving categorical terms

### 3.3 [ ] Introduce Terms metadata object
- R-like terms summary for downstream consumers
- Keep mapping from formula terms to design matrix columns

---

## Priority 4: Method Registry and Model Fits (Must Do)

### 4.1 [ ] Add FitMethod interface and registry
- Registry keyed by method name (lm, loess, gam)
- Method-specific parameter validation (span, degree, family, etc.)

### 4.2 [ ] Implement lm adapter using existing regressions
- Use LinearRegression/PolynomialRegression via the design matrix
- Support expanded formulas beyond simple poly degree

### 4.3 [ ] Implement loess
- Local regression with span/degree and tricube weights
- Accept weights from ModelFrame when provided
- Return fitted values and optional standard errors

### 4.4 [ ] Implement gam
- Decide strategy (native spline basis or dependency)
- Support smooth terms (s(x)) or document minimal subset

---

## Priority 5: Tests, Docs, and Validation (Must Do)

### 5.1 [ ] Parser and AST tests
- ., ^, /, parentheses, backticks, I(), poly(), s()
- Valid/invalid formula cases and edge conditions

### 5.2 [ ] ModelFrame tests
- weights/offset/subset/na.action behavior
- Dot expansion and exclusion

### 5.3 [ ] Design matrix and contrasts tests
- Column naming, categorical encoding, interactions

### 5.4 [ ] Method tests
- lm/loess/gam with known datasets
- Consistent output shapes and diagnostics

### 5.5 [ ] GroovyDoc and README updates
- Document formula syntax, supported methods, and limitations

### 5.6 [ ] Run matrix-stats tests
- Command: `./gradlew :matrix-stats:test`

---

## Priority 6: Linear Algebra Module (Should Do)

### 6.1 [ ] Define scope and API in matrix-stats
- Provide a `Linalg` facade under `se.alipsa.matrix.stats.linalg` (or a dedicated `matrix-linalg` module owned by stats)
- Decide numeric types, precision defaults, and conversion rules

### 6.2 [ ] EJML-based implementation
- `inverse`, `det`, `eigenvalues`, `svd`, `solve(A, b)`
- Add Matrix/Grid adapters and type conversion rules

### 6.3 [ ] Tests and documentation
- Numeric accuracy tests vs known results
- Document expected numeric types and precision limits

---

## Priority 7: Interpolation Utilities (Should Do)

### 7.1 [ ] Add interpolation helpers
- Linear interpolation for numeric columns/series
- Decide API surface (stat util vs dedicated Interpolation class)

### 7.2 [ ] Evaluate spline support
- Decide scope (linear only vs cubic/spline)
- Identify dependency or implement minimal spline math

---

## Priority 8: Remove commons-math3 Dependency (Should Do)

Apache Commons Math3 is deprecated and should be replaced with native implementations or alternative libraries. Current usage:

### 8.1 [ ] Update distribution classes with native implementations
- ChiSquaredDistribution, NormalDistribution, FDistribution, HypergeometricDistribution
- Used in: Ellipse, Fisher, ChiSquared, CochranArmitage, TurningPoint, Chow, Granger, CochranMantelHaenszel, Portmanteau, Lilliefors, KSquared, JarqueBera, KolmogorovSmirnov, ShapiroWilk, AndersonDarling, ShapiroFrancia, CramerVonMises
- Options: Implement CDF/PDF functions natively or use Smile's distributions (already a dependency in matrix-smile)

### 8.2 [ ] Update linear algebra classes with native implementations
- Array2DRowRealMatrix, LUDecomposition, RealMatrix
- Used in: RegressionUtils, Johansen
- Options: Implement using Grid operations or use EJML library

### 8.3 [ ] Update optimisation/solver classes
- PolynomialCurveFitter, SimplexOptimizer, NelderMeadSimplex, BrentSolver
- Used in: PolynomialRegression, LogisticRegression, QuantileRegression, GoalSeek
- Options: Implement polynomial fitting using normal equations, implement simplex natively

### 8.4 [ ] Update statistical utilities
- OLSMultipleLinearRegression, KolmogorovSmirnovTest, StatUtils
- Used in: Adf, KolmogorovSmirnov, ShapiroWilk, ShapiroFrancia
- Options: Extend existing LinearRegression for multiple regression, implement tests natively

### 8.5 [ ] Move commons-math3 to testImplementation only
- Keep for test validation/comparison if needed
- Remove from runtime dependencies

---

## Open Questions

### 9.1 [ ] Decide categorical handling strategy
- One-hot encoding vs. explicit error until categorical support is added
- Default contrasts and configuration surface

### 9.2 [ ] Decide gam implementation dependency
- Evaluate whether to implement internally or adopt a library

### 9.3 [ ] Decide formula evaluation scope
- Data-only evaluation vs. optional external environment resolution
