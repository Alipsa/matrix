# Matrix-Smile v0.1.0 Release Roadmap

## Release Status

The matrix-smile module is **nearly ready for v0.1.0** with excellent functionality, comprehensive test coverage (10/10 files tested), and thorough documentation (207 JavaDoc blocks). Only **4 critical issues** block the release, with an estimated **1-2 hours** to resolve.

---

## Release Blocking Issues (MUST FIX)

### 1. Modernize Switch Statements

**Priority:** CRITICAL
**File:** `src/main/groovy/se/alipsa/matrix/smile/stats/SmileStats.groovy`
**Locations:** Lines 535-546, 579-590, 625-636

**Issue:** Uses old-style colon syntax with `break` statements instead of modern arrow syntax required by AGENTS.md coding standards (Groovy 5.0+ + JDK 21). Note that DataframeConverter.groovy already uses modern arrow syntax, making the codebase inconsistent. Other matrix modules also use modern arrow-style switch statements, so this brings matrix-smile in line with the rest of the project.

**Current code pattern:**
```groovy
switch (method.toLowerCase()) {
  case "spearman":
    result = CorTest.spearman(data[i], data[j])
    break
  case "kendall":
    result = CorTest.kendall(data[i], data[j])
    break
  default:
    result = CorTest.pearson(data[i], data[j])
}
```

**Required fix:**
```groovy
switch (method.toLowerCase()) {
  case "spearman" -> result = CorTest.spearman(data[i], data[j])
  case "kendall" -> result = CorTest.kendall(data[i], data[j])
  default -> result = CorTest.pearson(data[i], data[j])
}
```

**Tasks:**
- 1.1 [x] Update switch statement at lines 535-546 (correlationMatrix method)
- 1.2 [x] Update switch statement at lines 579-590 (correlationMatrix method - p-values)
- 1.3 [x] Update switch statement at lines 625-636 (correlationMatrixWithP method)
- 1.4 [x] Run tests: `./gradlew :matrix-smile:test --tests "SmileStatsTest"` - **SUCCESS (45 tests passed)**

---

### 2. Update README - Groovy Version

**Priority:** CRITICAL
**File:** `README.md`
**Location:** Line 8

**Issue:** README states "Groovy 4.x" but the project requires Groovy 5.x for modern switch expression syntax (arrow operators). The module uses switch expressions in DataframeConverter.groovy (lines 76-158, 267-286) which are only supported in Groovy 5.0+. This aligns with other matrix modules that also use modern arrow-style switch statements.

**Current:**
```markdown
- Groovy 4.x
```

**Required fix:**
```markdown
- Groovy 5.0+
```

**Note:** The actual dependency is Groovy 5.0.4 (see dependencies.gradle), but saying "5.0+" allows for flexibility with future patch releases.

**Tasks:**
- 2.1 [x] Update README line 7 to specify "Groovy 5.0+" instead of "Groovy 4.x"
- 2.2 [x] Verify the change matches actual Groovy version in dependencies.gradle (currently 5.0.4) - **VERIFIED**
- 2.3 [x] Consider adding a note that arrow-style switch expressions require Groovy 5.0+ - **ADDED to README**

---

### 3. Fix Documentation Example - Remove println

**Priority:** CRITICAL
**File:** `src/main/groovy/se/alipsa/matrix/smile/Gsmile.groovy`
**Location:** Line 305

**Issue:** GroovyDoc example suggests using `println` which violates AGENTS.md logging guidelines. Documentation should not encourage System.out usage.

**Current:**
```groovy
* Usage: df.eachRow { println it['name'] }
```

**Required fix:**
```groovy
* Usage: df.eachRow { row -> log.info("Processing: ${row['name']}") }
```

Or use a more neutral example:
```groovy
* Usage: df.eachRow { row -> processRow(row['name']) }
```

**Tasks:**
- 3.1 [x] Update documentation example at line 305 to remove println suggestion
- 3.2 [x] Review other doc examples in Gsmile.groovy for println usage - **No other println found**
- 3.3 [x] Generate groovydoc to verify example appears correctly: `./gradlew :matrix-smile:groovydoc` - **BUILD SUCCESSFUL**

---

### 4. Align ExtensionModule Version

**Priority:** CRITICAL
**File:** `src/main/resources/META-INF/groovy/org.codehaus.groovy.runtime.ExtensionModule`

**Issue:** ExtensionModule declares `moduleVersion=1.0` which is inconsistent with the module's 0.1.0-SNAPSHOT version in build.gradle.

**Current:**
```properties
moduleVersion=1.0
```

**Required fix:**
```properties
moduleVersion=0.1.0
```

**Tasks:**
- 4.1 [x] Update moduleVersion to 0.1.0 in ExtensionModule file
- 4.2 [x] Rebuild and verify extension loads: `./gradlew :matrix-smile:build` - **BUILD SUCCESSFUL**
- 4.3 [x] Run extension tests: `./gradlew :matrix-smile:test --tests "GsmileTest"` - **SUCCESS (24 tests passed)**

---

## Recommended Improvements (SHOULD FIX)

### 5. Complete StandardScaler.transform() Implementation

**Priority:** HIGH
**File:** `src/main/groovy/se/alipsa/matrix/smile/data/SmileFeatures.groovy`
**Location:** Line 609

**Issue:** The `StandardScaler.transform()` method returns raw values instead of applying the fitted transformation. Currently, users must use `fitTransform()` even when working with pre-fitted scalers.

**Current behavior:**
```groovy
DataFrame transform(DataFrame df) {
  // TODO: Should apply stored mean/std to transform df
  // Currently returns df unchanged
  return df
}
```

**Expected behavior:**
```groovy
DataFrame transform(DataFrame df) {
  // Apply fitted mean and std to normalize df
  def scaledColumns = numericColumns.collectEntries { col ->
    def original = df.column(col).toDoubleArray()
    def scaled = original.collect { (it - means[col]) / stds[col] } as double[]
    [col, scaled]
  }
  // Reconstruct DataFrame with scaled values
}
```

**Tasks:**
- 5.1 [ ] Implement proper StandardScaler.transform() using stored means and stds
- 5.2 [ ] Add test case for separate fit() and transform() workflow in SmileFeaturesTest
- 5.3 [ ] Update GroovyDoc to clarify transform() requires prior fit() call
- 5.4 [ ] Run tests: `./gradlew :matrix-smile:test --tests "SmileFeaturesTest.testStandardScaler*"`

---

### 6. Review .doubleValue() Usage for Idiomatic Alternatives

**Priority:** MEDIUM
**Files:** Multiple (19 occurrences across 8 files)

**Issue:** Excessive use of `.doubleValue()` which AGENTS.md identifies as a code smell. Many can be replaced with idiomatic Groovy `as double` coercion.

**Example locations:**
- SmileFeatures.groovy: Lines 242, 381, 383, 469, 470
- SmileCluster.groovy: Multiple locations
- SmileRegression.groovy: Multiple locations

**Anti-pattern:**
```groovy
double x = (value as Number).doubleValue()
```

**Preferred:**
```groovy
double x = value as double
```

**Tasks:**
- 6.1 [ ] Search all files for `.doubleValue()` pattern
- 6.2 [ ] Replace with `as double` where type casting is clear
- 6.3 [ ] Keep .doubleValue() only where interfacing with Smile's primitive APIs requires it
- 6.4 [ ] Run full test suite: `./gradlew :matrix-smile:test`

---

### 7. Reduce Math Calls in Non-Performance-Critical Code

**Priority:** LOW
**Files:** Multiple (20 Math.* occurrences across 6 files)

**Issue:** Per AGENTS.md, should prefer BigDecimal and NumberExtension methods over java.lang.Math. However, since this module interfaces with Smile ML (which uses primitive doubles for performance), some Math usage is justified.

**Top offenders:**
- SmileFeatures.groovy: 9 Math calls (log1p, sqrt, pow, round, max, min)
- SmileStats.groovy: Math in statistical calculations
- SmileCluster.groovy: Math.sqrt in silhouette calculation

**Review criteria:**
- ‚úÖ **Keep:** Math usage in ML algorithm wrappers (performance-critical)
- ‚ö†Ô∏è **Consider replacing:** Math in feature transformations where precision matters
- ‚ö†Ô∏è **Consider replacing:** Math for simple operations like max/min

**Example replacement opportunities:**
```groovy
// Current
Math.sqrt(value)
Math.log(value)

// Could use NumberExtension
value.sqrt()
value.log()
```

**Tasks:**
- 7.1 [ ] Audit all Math.* calls and categorize: performance-critical vs. replaceable
- 7.2 [ ] Replace Math calls with NumberExtension in SmileFeatures transformations
- 7.3 [ ] Keep Math calls in SmileClassifier, SmileRegression, SmileCluster (ML algorithms)
- 7.4 [ ] Run full test suite: `./gradlew :matrix-smile:test`
- 7.5 [ ] Benchmark if performance impact is measurable

---

## Release Checklist

### Pre-Release Tasks

- [ ] All blocking issues (1-4) are resolved
- [ ] All tests pass: `./gradlew :matrix-smile:test`
- [ ] Run full project tests: `./gradlew test`
- [ ] No test failures or warnings
- [ ] Build succeeds: `./gradlew :matrix-smile:build`
- [ ] GroovyDoc generates without errors: `./gradlew :matrix-smile:groovydoc`
- [ ] Review generated docs in `build/docs/groovydoc/`

### Version Management

- [ ] Update version in build.gradle from `0.1.0-SNAPSHOT` to `0.1.0`
- [ ] Ensure ExtensionModule version matches (0.1.0)
- [ ] Verify README examples still work with final version

### Publication

- [ ] Publish to Maven local: `./gradlew :matrix-smile:publishToMavenLocal`
- [ ] Test integration with matrix-core
- [ ] Create release tag: `git tag matrix-smile-0.1.0`
- [ ] Push to Maven Central (if applicable)

### Documentation

- [ ] Update main project README to mention matrix-smile
- [ ] Add matrix-smile examples to matrix-examples (if desired)
- [ ] Update AGENTS.md module table if needed

---

## Future Enhancements (v0.2.0 and beyond)

These items are **not blocking v0.1.0** but represent opportunities for future releases:

### Advanced ML Features
- Neural networks (Smile MLP integration)
- SVM support (Support Vector Machines)
- Gradient boosting (XGBoost integration)
- Ensemble methods beyond Random Forest

### Model Persistence
- Model serialization/deserialization
- Save trained models to disk
- Load pre-trained models
- Export models to standard formats (PMML, ONNX)

### Time Series Analysis
- ARIMA models
- Seasonal decomposition
- Forecasting utilities
- Rolling window operations

### Additional Distributions
- More probability distributions (Beta, Gamma, etc.)
- Distribution fitting beyond Weibull
- Q-Q plot generation

### Performance Optimizations
- Parallel processing for large datasets
- Streaming data support
- GPU acceleration (if Smile adds support)

---

## Module Quality Summary

### ‚úÖ Strengths

- **Excellent test coverage:** 10/10 files tested with comprehensive test suites (3,289 lines)
- **Strong documentation:** 207 JavaDoc blocks, complete API reference, usage examples
- **Comprehensive functionality:** Data conversion, feature engineering, ML algorithms, statistics
- **Proper architecture:** Extension module correctly registered, @CompileStatic throughout
- **Type safety:** Proper generic usage, comprehensive null handling
- **Modern practices:** Uses Logger utility (DataframeConverter), modern switch in some files

### ‚ö†Ô∏è Areas for Improvement

- Old-style switch statements in SmileStats.groovy (blocking)
- Documentation inconsistencies (README Groovy version, println example)
- StandardScaler.transform() incomplete implementation
- Heavy .doubleValue() usage (acceptable for ML but could be more idiomatic)
- Math method usage (justified for performance but could use BigDecimal in places)

### üìä Metrics

- **Source files:** 10
- **Test files:** 10 (100% coverage)
- **Lines of code:** ~3,500 (source) + 3,289 (tests)
- **JavaDoc blocks:** 207
- **Supported data types:** 19
- **ML algorithms:** 8+ (classifiers, regressors, clusterers, PCA)
- **Statistical distributions:** 14
- **Hypothesis tests:** 4

---

## Notes

- The module interfaces with Smile ML library (version 4.4.2), which uses primitive doubles for performance
- Some Java Math usage and .doubleValue() calls are justified for ML performance
- Module is constrained to Java 21 maximum due to Smile 4.x compatibility
- **Groovy 5.0+ is required** (not 4.x as README currently states)
  - Modern switch expression syntax (arrow operators) used in DataframeConverter.groovy requires Groovy 5.0+
  - This aligns with other matrix modules that use modern arrow-style switch statements
  - Project uses Groovy 5.0.4 in dependencies.gradle, uses `compileOnly` scope for flexibility
