# v3.6.0 Roadmap - Matrix Core Review

## Overview
This roadmap addresses critical bugs, performance issues, code quality improvements, and API consistency across matrix-core. Issues are prioritized by severity and impact.

## Critical Bugs (Must Fix)

### 1. Matrix/Grid dropExcept() ConcurrentModificationException
**Files:**
- `matrix-core/src/main/groovy/se/alipsa/matrix/core/Matrix.groovy:953`
- `matrix-core/src/main/groovy/se/alipsa/matrix/core/Grid.groovy:930-962`
**Severity:** HIGH - Removes columns while iterating, causing index shifts
**Impact:** Columns that should be removed may be kept due to index invalidation

### 2. Matrix.rowIndices() Never Evaluates Criteria
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/Matrix.groovy:2139`
**Severity:** HIGH - Extra closure block prevents criteria execution
**Impact:** Methods like `removeEmptyRows()` always receive empty index list

### 3. MatrixAssertions Never Throw Exceptions
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/MatrixAssertions.groovy:17`
**Severity:** HIGH - `assertNotEquals` and `assertContentNotEquals` create but don't throw exceptions
**Impact:** Negative assertions never fail, tests don't catch bugs

### 4. Stat.variance() Division by Zero
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/Stat.groovy:749-763`
**Severity:** MEDIUM - When size=1 and isBiasCorrected=true, divides by zero
**Impact:** ArithmeticException in valid statistical scenarios

### 5. MatrixBuilder Path.contains() Bug
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/MatrixBuilder.groovy:360`
**Severity:** MEDIUM - Calls `.contains('.')` on Path instead of filename string
**Impact:** Incorrect file extension detection

### 6. Matrix diff/checkValues Treats 0 as Falsy
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/Matrix.groovy:895,1111`
**Severity:** MEDIUM - Uses `?: Double.NaN` which treats `0` as false
**Impact:** Hides numeric differences when comparing against zero

### 7. Matrix.removeRows(List) Incorrect Sorting
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/Matrix.groovy:1949`
**Severity:** MEDIUM - Calls `Arrays.sort(indexes)` on List (no-op)
**Impact:** Row removal order undefined for unsorted input, potential incorrect removals

### 8. Matrix.split() Semantics Issues
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/Matrix.groovy:2240`
**Severity:** LOW - Doc example contradicts parameter name; edge case `chunkSize > rowCount()` yields `collate(0)`
**Impact:** Confusing API, potential unexpected behavior

### 9. Matrix.dropEmptyColumns() Incomplete Implementation
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/Matrix.groovy:1968`
**Severity:** LOW - Doc claims to drop blank strings but only checks null
**Impact:** Behavior doesn't match documentation

### 10. ListConverter.convert() Reversed Type Check
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/ListConverter.groovy:23`
**Severity:** LOW - Uses reversed `isAssignableFrom`, so assignable values still convert
**Impact:** Unnecessary conversions, potential type coercion bugs

## Code Quality & Performance

### 11. Grid.toString() Implicit Return
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/Grid.groovy:161-165`
**Severity:** LOW - Uses Groovy's implicit return with StringBuilder auto-coercion
**Recommendation:** Add explicit `sb.toString()` or `return sb.toString()` for clarity
**Impact:** Code readability (method works correctly as-is)

### 12. Massive Duplication in ClassUtils.nearest()
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/util/ClassUtils.groovy:96-188`
**Severity:** MEDIUM - 92 lines of repetitive if-statements (42 conditions)
**Recommendation:** Refactor to Map-based lookup table or priority algorithm
**Impact:** Maintainability, readability

### 13. Code Duplication in Column Arithmetic Operations
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/Column.groovy:64-224`
**Severity:** LOW - All arithmetic operations have identical null-checking patterns
**Recommendation:** Extract to common `applyOperation(Closure, Object)` method
**Impact:** Maintainability, DRY principle

### 14. Duplicate Cache Management in ValueConverter
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/ValueConverter.groovy:504-520`
**Severity:** LOW - Two nearly identical cache methods
**Recommendation:** Unify caching pattern
**Impact:** Maintainability

### 15. Performance: Nested Loops in Stat Methods
**Files:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/Stat.groovy`
**Methods:** `sd()`, `means()`, `medians()` (lines 376-742)
**Severity:** LOW - O(n*m) with intermediate data structures
**Recommendation:** Use columnar access instead of row iteration
**Impact:** Performance on large matrices

### 16. Unsafe JDK Internal Import
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/util/ClassUtils.groovy:4`
**Severity:** LOW - `import jdk.internal.reflect.Reflection` (unused)
**Impact:** May break in future JDK versions

## Dependency Management

### 24. opentest4j Incorrect Scope
**File:** `matrix-core/build.gradle:43`
**Severity:** LOW - Declared as `implementation` instead of `testImplementation`
**Impact:** Unnecessary runtime dependency in published artifacts

## API & Documentation

### 17. Missing Null Checks in Stat Methods
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/Stat.groovy:74`
**Severity:** LOW - `addNumericSummary()` returns null but callers don't check
**Impact:** Potential NPEs

### 18. Inconsistent Null Handling in ValueConverter
**Files:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/ValueConverter.groovy`
**Severity:** LOW - Different methods handle blank/empty strings differently
**Impact:** API inconsistency, user confusion

### 19. Inconsistent Parameter Order in Converters
**Files:** `ListConverter.groovy`, `ValueConverter.groovy`
**Severity:** LOW - Similar methods have different parameter orders
**Impact:** API confusion, error-prone mistakes

### 20. Console Output Instead of Logging
**Files:**
- `matrix-core/src/main/groovy/se/alipsa/matrix/core/MatrixBuilder.groovy:481`
- `matrix-core/src/main/groovy/se/alipsa/matrix/core/Stat.groovy:74`
**Severity:** LOW - Uses System.err.println instead of logging framework
**Impact:** Poor production practices

### 21. Missing/Incomplete JavaDoc
**Files:** Multiple
**Examples:**
- `MatrixBuilder.rows()` (line 120) - No parameter docs
- `Grid.isValid()` (line 286) - No documentation
- Typos: "Insert a row **i** the specified position" (Grid:80), "Flloat" (ClassUtils:81)
**Impact:** Developer experience

### 22. Deprecated Methods Without Clear Migration
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/Matrix.groovy`
**Count:** 9 deprecated methods
**Impact:** Users uncertain when removal occurs, performance implications, behavioral differences

## Architecture & Design

### 25. Brittle getAt/putAt Method Dispatching
**Files:**
- `matrix-core/src/main/groovy/se/alipsa/matrix/core/Matrix.groovy:1337-1376` (getAt)
- `matrix-core/src/main/groovy/se/alipsa/matrix/core/Matrix.groovy:1592-1651` (putAt)
**Severity:** MEDIUM - Long if-else chains for type dispatching across multiple overloads
**Recommendation:** Refactor to strategy pattern or multimethod dispatch for better maintainability
**Impact:** Maintainability, extensibility, error-proneness when adding new overloads

### 26. Matrix-MatrixPrinter Dependency Coupling
**Files:**
- `matrix-core/src/main/groovy/se/alipsa/matrix/core/Matrix.groovy:6,1396`
- `matrix-core/src/main/groovy/se/alipsa/matrix/core/util/MatrixPrinter.groovy`
**Severity:** LOW - Matrix depends on MatrixPrinter for formatting operations
**Recommendation:** Invert dependency - Matrix could expose data access, MatrixPrinter consumes it
**Impact:** Separation of concerns, testability, potential for alternative formatters

### 27. ValueConverter Modularity
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/ValueConverter.groovy`
**Severity:** MEDIUM - Large monolithic class (584 lines) with many type-specific conversion methods
**Analysis:** Caching is an implementation detail (performance optimization for formatters), and formatting is just conversion-to-string. The real issue is size and organization.
**Recommendation:** Consider organizing by conversion strategy or target type families:
  - Numeric converters (BigDecimal, Integer, Double, etc.)
  - Temporal converters (LocalDate, LocalDateTime, YearMonth, etc.)
  - String converters
**Impact:** Maintainability, testability, code comprehension
**Related items:** #14 (cache duplication at lines 504-520), #18 (null handling inconsistency)

## Test Coverage Gaps

### 23. Edge Cases Needing Tests
- Empty matrix operations: `Stat.str()`, `Matrix.dropExcept()`, `Grid.transpose()`
- Null input handling: `ListConverter.convert()` with all-null list, `Stat.median()` with single element
- Boundary conditions: `Matrix.apply()` with invalid columnNumber, `Row.move()` edge cases

## Implementation Plan

### Phase 1: Critical Bug Fixes (Priority 1)
1.1 [x] Fix `Matrix.rowIndices()` to execute criteria and add regression test for `removeEmptyRows` (Matrix.groovy:2139)
1.2 [x] Fix `MatrixAssertions` to throw exceptions in `assertNotEquals`/`assertContentNotEquals` (MatrixAssertions.groovy:17)
1.3 [x] Rewrite `Matrix.dropExcept(int...)` and `Grid.dropExcept()` to avoid index-shift bugs; add coverage (Matrix.groovy:953, Grid.groovy:930-962 - Note: Grid.dropExcept() did not exist)
1.4 [x] Add division-by-zero check in `Stat.variance()` (Stat.groovy:761)
1.5 [x] Fix `MatrixBuilder` Path.contains() bug - use filename string instead of Path (MatrixBuilder.groovy:360)
1.6 [x] Update `diff` and `checkValues` to handle nulls explicitly without treating `0` as false; add tests (Matrix.groovy:895,1111)
1.7 [x] Replace `Arrays.sort(indexes)` with `indexes.sort()` in `removeRows(List)` and test unsorted removal (Matrix.groovy:1949)
1.8 [x] Run tests: `./gradlew :matrix-core:test` - **SUCCESS (199 tests, 199 passed, 0 failed, 0 skipped)**

### Phase 2: Code Quality & Refactoring (Priority 2)
2.1 [x] Add explicit return to `Grid.toString()` for clarity (Grid.groovy:165)
2.2 [x] Refactor `ClassUtils.nearest()` to use lookup table - Reduced from 92 lines to 35 lines using Map-based lookup (ClassUtils.groovy:95-129)
2.3 [x] Extract common null-handling in Column arithmetic operations to `applyOperation()` method (Column.groovy:64-224)
2.4 [x] Refactor ValueConverter for better modularity (#27)
2.4.1 [x] Unify duplicate cache management methods - Made `dateTimeFormatter` consistent with `simpleDateFormatCache` by including locale in cache key (ValueConverter.groovy:513-521)
2.4.2 [ ] Consider organizing conversions by target type families (numeric, temporal, string converters) - Deferred to future release
2.5 [x] Remove unused `jdk.internal.reflect.Reflection` import (ClassUtils.groovy:3)
2.6 [x] Add null-check handling in `Stat.addNumericSummary()` callers - Added null checks in both summary() methods (Stat.groovy:52-54,68-71)
2.7 [x] Fix `ListConverter.convert()` assignability check to `type.isAssignableFrom(it.class)` (ListConverter.groovy:30)
2.8 [x] Fix opentest4j dependency scope from `implementation` to `testImplementation` and replace AssertionFailedError with IllegalArgumentException in Matrix.handleError() (build.gradle:43, Matrix.groovy:1102)
2.9 [ ] Consider refactoring `getAt/putAt` dispatching methods for better maintainability (#25) - Deferred to future release
2.10 [x] Run tests: `./gradlew :matrix-core:test` - **SUCCESS (199 tests, 199 passed, 0 failed, 0 skipped)**

### Phase 3: API & Documentation (Priority 3)
3.1 [x] Clarify `split(int chunkSize)` semantics - **Preserved backward compatibility** by keeping original `split(int chunkSize)` behavior unchanged. Added new `splitInto(int numChunks)` method with improved semantics that distributes rows evenly using base size + remainder algorithm, with validation for edge cases. Updated tests to cover both methods (Matrix.groovy:2243-2290, MatrixTest.groovy:1388-1440)
3.2 [x] Align `dropEmptyColumns` behavior with docs - Now uses `containsValues()` to properly check for blank strings. Added test coverage for blank string handling (Matrix.groovy:1978-1988, MatrixTest.groovy:1008-1023)
3.3 [ ] Standardize logging framework (#20) - **REVERTED**: SLF4J adds dependency complexity for scripting use cases; System.err.println is appropriate for this library
3.3.1 [~] Add SLF4J facade dependency to build.gradle - Reverted
3.3.2 [~] Replace System.err.println with SLF4J logger calls - Reverted
3.4 [ ] Standardize null/empty string handling in ValueConverter methods (part of #27) - Deferred to future release
3.5 [ ] Document deprecated methods: removal timeline, performance implications, behavioral differences - Deferred to future release
3.6 [x] Fix JavaDoc typos and add missing documentation:
     - Grid.groovy:75 - Fixed "Insert a row i" → "at"
     - ClassUtils.groovy:80 - Fixed "Flloat" → "Float", "hiearchy" → "hierarchy"
     - Grid.isValid():283,287 - Added comprehensive JavaDoc for both overloads
3.7 [ ] Consider MatrixPrinter dependency inversion for better separation of concerns (#26) - Deferred to future release
3.8 [x] Run tests: `./gradlew :matrix-core:test` - **SUCCESS (202 tests, 202 passed, 0 failed, 0 skipped)** - Added 3 new tests: dropEmptyColumns blank strings, splitInto, splitInto edge cases

### Phase 4: Performance & Testing (Priority 4)
4.1 [x] Optimize Stat methods to use columnar access instead of nested row iteration - Optimized means(), medians(), and sd() methods for Matrix to use direct column access, eliminating O(n*m) row iteration (Stat.groovy:405-420,521-530,771-785)
4.2 [x] Add tests for empty matrix edge cases - Added tests for Stat.str(), Matrix.dropExcept(), and Grid.transpose() with empty matrices (StatTest.groovy:428-445, MatrixTest.groovy:694-712, GridTest.groovy:161-182)
4.3 [x] Add tests for null input handling edge cases - Added comprehensive null input tests for mean, median, sd, variance methods (StatTest.groovy:447-464)
4.4 [x] Add tests for boundary conditions - Added single-element tests including sd() with bias correction edge case (StatTest.groovy:466-481)
4.5 [x] Review @CompileDynamic methods for static compilation opportunities - Reviewed 41 @CompileDynamic usages; identified candidates in Column arithmetic and Stat methods; deferred conversion to future release as optimization would require careful testing
4.6 [x] Fix sd() null handling bug - Fixed NPE when variance returns null (e.g., single element with bias correction) by adding null check before Math.sqrt (Stat.groovy:817-819)
4.7 [x] Fix means() division by zero bug - Added check for count == 0 to return null instead of throwing ArithmeticException for columns with no numeric values (Stat.groovy:419)
4.8 [x] Fix medians() redundant sorting - Removed redundant sort() call since median() internally creates a copy and sorts; eliminates duplicate O(n log n) work (Stat.groovy:528)
4.9 [x] Add test coverage for non-numeric columns - Added testStatMethodsWithNoNumericValues() to verify means/medians handle all-null, all-string, and mixed non-numeric columns correctly (StatTest.groovy:483-510)
4.10 [x] Run full test suite: `./gradlew :matrix-core:test` - **SUCCESS (208 tests, 208 passed, 0 failed, 0 skipped)** - Added 6 new edge case tests

### Phase 5: Build Infrastructure & Quality Tools (Priority 5)
5.1 [ ] Integrate static analysis tooling
5.1.1 [ ] Evaluate CodeNarc vs SonarLint for Groovy code quality analysis
5.1.2 [ ] Configure chosen tool with appropriate rule sets for the project
5.1.3 [ ] Add static analysis to build pipeline (./gradlew check)
5.2 [ ] Integrate code coverage tooling
5.2.1 [ ] Add JaCoCo plugin to build.gradle for test coverage measurement
5.2.2 [ ] Configure coverage thresholds and reporting
5.2.3 [ ] Generate coverage reports: `./gradlew jacocoTestReport`
5.3 [ ] Document new build targets and quality gates in README

## Success Criteria
- [x] All critical bugs (Phase 1) fixed with tests
- [x] Code quality improvements (Phase 2) completed
- [x] API & documentation improvements (Phase 3) completed
- [x] Performance optimizations (Phase 4) completed - Stat methods now use columnar access with proper null handling
- [x] Test suite passes: `./gradlew :matrix-core:test` (208/208 tests passing - includes 6 new edge case tests)
- [x] No regression in existing functionality
- [x] Backward compatibility maintained (split() semantics preserved, new splitInto() method added)
- [x] Bug fixes for optimization edge cases (division by zero, redundant sorting)
- [ ] Code coverage maintained or improved (measured via JaCoCo) - Deferred to Phase 5
- [ ] Static analysis passing (CodeNarc/SonarLint) - Deferred to Phase 5
- [x] Documentation updated for all changes
- [x] Dependency management cleaned up (opentest4j scope corrected; SLF4J standardization reverted)
