# v3.6.1 Roadmap - Code Quality & Technical Debt

## Overview
v3.6.1 focuses on code quality improvements identified by CodeNarc static analysis and completion of architectural refactoring deferred from v3.6.0. This release addresses 454 CodeNarc violations across 18 files and improves code maintainability without adding new features.

## CodeNarc Static Analysis Results
- **Total Violations:** 454 (0 Priority 1, 224 Priority 2, 230 Priority 3)
- **Report Location:** `build/reports/codenarc/main.html`
- **Baseline Version:** 3.6.0 with CodeNarc 3.5.0

## Code Quality Issues

### Priority 2 Violations (Major Issues)

#### 1. Instanceof Overuse (84 violations)
**Severity:** HIGH - Indicates potential type hierarchy issues or missing polymorphism
**Files:** ValueConverter.groovy, Column.groovy, Stat.groovy, ListConverter.groovy
**Impact:** Code duplication, maintainability, potential performance
**Recommendation:**
- Replace instanceof chains with polymorphism or strategy pattern where appropriate
- Consider using Groovy's multiple dispatch for type-specific operations
- Evaluate if type checking can be replaced with duck typing in dynamic contexts

#### 2. Duplicate String Literals (36 violations)
**Severity:** MEDIUM - Magic strings scattered across codebase
**Files:** Multiple files
**Impact:** Maintainability, refactoring difficulty, typo risk
**Recommendation:**
- Extract commonly used strings to constants
- Create StringConstants or MessageConstants utility class for shared literals
- Consider using enums for string-based state or type representations

#### 3. Unnecessary GString Usage (35 violations)
**Severity:** MEDIUM - Performance overhead for non-interpolated strings
**Files:** Multiple files
**Impact:** Unnecessary object allocation, reduced performance
**Recommendation:**
- Replace GStrings without interpolation (e.g., `"${value}"` â†’ `'value'` or `"value"`) with plain strings
- Use GStrings only when actual string interpolation is needed
- Review string concatenation patterns

#### 4. Duplicate Number Literals (28 violations)
**Severity:** MEDIUM - Magic numbers throughout codebase
**Files:** Multiple files
**Impact:** Maintainability, unclear intent
**Recommendation:**
- Extract numeric constants with meaningful names
- Document significance of threshold values
- Consider configuration for magic numbers that might need tuning

#### 5. Implementation Type References (9 violations)
**Severity:** MEDIUM - Dependencies on concrete implementations instead of interfaces
**Files:** Multiple files
**Examples:** Using `ArrayList` instead of `List`, `HashMap` instead of `Map`
**Impact:** Coupling to implementation details, reduced flexibility
**Recommendation:**
- Declare variables and parameters using interface types (List, Map, Set)
- Use concrete types only for instantiation
- Improves testability and future refactoring options

### Priority 3 Violations (Minor Issues)

#### 6. Operator Spacing (28 violations)
**Severity:** LOW - Formatting inconsistency
**Files:** Multiple files
**Impact:** Code readability, style consistency
**Recommendation:**
- Enforce consistent spacing around operators (+, -, *, /, ==, etc.)
- Consider integrating automatic code formatter (e.g., Spotless)

#### 7. Brace Formatting (25 violations)
**Severity:** LOW - Inconsistent brace placement
**Files:** Multiple files
**Impact:** Code readability, style consistency
**Recommendation:**
- Standardize opening brace placement (K&R vs Allman style)
- Configure CodeNarc to enforce chosen style
- Apply fixes automatically where possible

#### 8. If Statement Braces (21 violations)
**Severity:** LOW - Missing braces on single-line if statements
**Files:** Multiple files
**Impact:** Potential bugs when adding code, readability
**Recommendation:**
- Add braces to all if/else/for/while statements even when single-line
- Prevents Apple "goto fail" style bugs
- Improves code clarity

#### 9. Nested For Loops (10 violations)
**Severity:** LOW - Complexity indicator
**Files:** Multiple files
**Impact:** Code complexity, potential performance issues
**Recommendation:**
- Review each case for optimization opportunities
- Consider extracting inner loops to separate methods
- Evaluate if functional style (collect, findAll, etc.) would improve clarity

## Deferred Items from v3.6.0

### Architecture & Design

#### 10. ValueConverter Type Family Organization (v3.6.0 #2.4.2)
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/ValueConverter.groovy`
**Severity:** MEDIUM - 584-line monolithic class
**Description:** Large class with many type-specific conversion methods lacks clear organization
**Recommendation:** Organize conversions by target type families:
- Numeric converters (BigDecimal, Integer, Double, Long, etc.)
- Temporal converters (LocalDate, LocalDateTime, YearMonth, etc.)
- String/formatting converters
- Boolean converters
**Related Issues:** #1 (instanceof overuse), #2 (string duplication in converters)
**Impact:** Maintainability, testability, code comprehension

#### 11. getAt/putAt Method Dispatching Refactoring (v3.6.0 #2.9)
**Files:**
- `matrix-core/src/main/groovy/se/alipsa/matrix/core/Matrix.groovy:1337-1376` (getAt)
- `matrix-core/src/main/groovy/se/alipsa/matrix/core/Matrix.groovy:1592-1651` (putAt)
**Severity:** MEDIUM - Long if-else chains for type dispatching
**Description:** Multiple overloads with brittle type-checking chains
**Recommendation:** Refactor to strategy pattern or multimethod dispatch
**Impact:** Maintainability, extensibility, error-proneness when adding new overloads
**Related Issues:** #1 (instanceof overuse)

#### 12. MatrixPrinter Dependency Inversion (v3.6.0 #3.7)
**Files:**
- `matrix-core/src/main/groovy/se/alipsa/matrix/core/Matrix.groovy:6,1396`
- `matrix-core/src/main/groovy/se/alipsa/matrix/core/util/MatrixPrinter.groovy`
**Severity:** LOW - Matrix depends on MatrixPrinter for formatting
**Description:** Current dependency direction couples Matrix to specific formatting implementation
**Recommendation:** Invert dependency - Matrix exposes data access, MatrixPrinter consumes it
**Impact:** Separation of concerns, testability, potential for alternative formatters

### API & Documentation

#### 13. ValueConverter Null/Empty String Handling Standardization (v3.6.0 #3.4)
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/ValueConverter.groovy`
**Severity:** LOW - Inconsistent null handling across conversion methods
**Description:** Different methods handle blank/empty strings differently
**Impact:** API inconsistency, user confusion, potential bugs
**Recommendation:**
- Document null/empty string behavior for each conversion method
- Standardize behavior across similar conversion types
- Consider adding NullHandlingStrategy parameter where appropriate

#### 14. Deprecated Method Documentation (v3.6.0 #3.5)
**File:** `matrix-core/src/main/groovy/se/alipsa/matrix/core/Matrix.groovy`
**Count:** 9 deprecated methods
**Severity:** LOW - Missing migration guidance
**Impact:** Users uncertain about removal timeline, performance implications, behavioral differences
**Recommendation:**
- Document removal timeline (version number)
- Explain performance implications of deprecated vs new methods
- Provide migration examples for each deprecated method
- Consider deprecation policy for future releases

### Performance Optimization

#### 15. @CompileDynamic to Static Compilation Migration (v3.6.0 #4.5)
**Files:** 41 @CompileDynamic usages across codebase
**Severity:** LOW - Potential performance improvements
**Description:** Many methods marked @CompileDynamic could potentially use static compilation
**Candidates Identified:**
- Column arithmetic operations
- Stat calculation methods
**Recommendation:**
- Profile performance impact before/after conversion
- Start with high-frequency methods (Stat calculations, Column operations)
- Ensure comprehensive test coverage before conversion
- Measure performance gains to validate optimization
**Impact:** Performance (potential 2-10x improvement in hot paths)
**Related Issues:** Would help reduce #1 (instanceof usage) through static type checking

## Implementation Plan

### Phase 1: High-Impact Code Quality (Priority 1)
**Goal:** Address Priority 2 violations with highest impact on maintainability

1.1 [ ] Reduce instanceof usage in ValueConverter (relates to #10)
    - Replace type checking chains with strategy pattern
    - Group converters by type family
    - Estimated: 40-50 violations addressable

1.2 [ ] Extract duplicate string literals to constants
    - Create StringConstants utility class
    - Replace magic strings in error messages
    - Replace magic strings in column names and operations
    - Estimated: 36 violations

1.3 [ ] Replace unnecessary GStrings with plain strings
    - Automated search and replace for non-interpolated GStrings
    - Review string concatenation patterns
    - Estimated: 35 violations

1.4 [ ] Extract duplicate number literals to named constants
    - Document significance of threshold values
    - Create NumericConstants for common values
    - Estimated: 28 violations

1.5 [ ] Replace implementation type references with interfaces
    - Change declarations from ArrayList/HashMap to List/Map
    - Estimated: 9 violations

1.6 [ ] Run tests and verify no regressions: `./gradlew :matrix-core:test`

### Phase 2: Architecture Refactoring (Priority 2)
**Goal:** Complete deferred architectural improvements from v3.6.0

2.1 [ ] Organize ValueConverter by type families (#10)
    - Create base converter interface/abstract class
    - Extract numeric converters to NumericConverter
    - Extract temporal converters to TemporalConverter
    - Extract string/formatting converters
    - Preserve existing API compatibility
    - Update tests for new structure

2.2 [ ] Refactor getAt/putAt dispatching (#11)
    - Design strategy pattern for index type handling
    - Create IndexStrategy interface
    - Implement strategies for Int, IntRange, List, String, etc.
    - Replace if-else chains with strategy lookup
    - Maintain backward compatibility
    - Add tests for all strategy types

2.3 [ ] Invert MatrixPrinter dependency (#12)
    - Extract MatrixData interface from Matrix
    - Update MatrixPrinter to depend on interface
    - Remove direct Matrix-to-MatrixPrinter coupling
    - Verify formatting functionality unchanged

2.4 [ ] Run tests and verify no regressions: `./gradlew :matrix-core:test`

### Phase 3: Formatting & Style Cleanup (Priority 3)
**Goal:** Address Priority 3 violations for consistent code style

3.1 [ ] Configure and apply code formatter
    - Evaluate Spotless or similar tool
    - Configure formatter rules (spacing, braces)
    - Apply to codebase

3.2 [ ] Fix operator spacing violations
    - Apply formatter or manual fixes
    - Estimated: 28 violations

3.3 [ ] Fix brace formatting violations
    - Standardize on K&R or Allman style
    - Apply consistently
    - Estimated: 25 violations

3.4 [ ] Add braces to single-line if statements
    - Manual review and fix
    - Estimated: 21 violations

3.5 [ ] Review and simplify nested for loops
    - Extract to methods where appropriate
    - Consider functional alternatives
    - Estimated: 10 violations

3.6 [ ] Run CodeNarc and verify violation reduction: `./gradlew codenarcMain`

### Phase 4: API & Documentation (Priority 4)
**Goal:** Improve API consistency and documentation

4.1 [ ] Standardize ValueConverter null/empty handling (#13)
    - Audit all conversion methods
    - Document current behavior
    - Identify inconsistencies
    - Implement standardized handling
    - Update JavaDoc with null behavior

4.2 [ ] Document deprecated methods (#14)
    - Add removal timeline to @Deprecated annotations
    - Document performance implications
    - Add migration examples to JavaDoc
    - Create deprecation guide in documentation

4.3 [ ] Run tests and verify documentation builds: `./gradlew :matrix-core:test groovydoc`

### Phase 5: Performance Optimization (Priority 5)
**Goal:** Convert @CompileDynamic to static compilation where beneficial

5.1 [ ] Profile baseline performance (@CompileDynamic)
    - Create benchmark suite for Column operations
    - Create benchmark suite for Stat methods
    - Record baseline metrics

5.2 [ ] Convert high-frequency methods to static compilation
    - Start with Column arithmetic (plus, minus, multiply, divide)
    - Convert Stat calculation methods
    - Measure performance impact

5.3 [ ] Evaluate and document performance gains
    - Compare benchmark results
    - Document methods converted
    - Decide on further conversion based on gains

5.4 [ ] Run full test suite: `./gradlew :matrix-core:test`

### Phase 6: Quality Verification (Priority 6)
**Goal:** Verify all improvements and ensure quality gates pass

6.1 [ ] Run full test suite with coverage: `./gradlew :matrix-core:test jacocoTestReport`
    - Verify 208+ tests passing
    - Verify coverage >= 70% overall
    - Review coverage report for gaps

6.2 [ ] Run CodeNarc static analysis: `./gradlew codenarcMain`
    - Compare violation counts to baseline (454 total)
    - Target: <200 total violations
    - Verify 0 Priority 1 violations

6.3 [ ] Run all quality gates: `./gradlew :matrix-core:check`
    - Verify tests pass
    - Verify coverage thresholds met
    - Verify CodeNarc violations reduced

6.4 [ ] Update documentation
    - Update README with any API changes
    - Document new constants and utilities
    - Update migration guide for deprecated methods

## Success Criteria
- [ ] CodeNarc violations reduced from 454 to <200 total
- [ ] Priority 2 violations reduced by at least 75% (from 224 to <56)
- [ ] All deferred v3.6.0 items completed
- [ ] Test suite passes: `./gradlew :matrix-core:test` (208+ tests)
- [ ] Code coverage maintained: >=70% overall, >=30% per-class
- [ ] No regression in existing functionality
- [ ] Backward compatibility maintained (no breaking API changes)
- [ ] Build quality gates pass: `./gradlew :matrix-core:check`
- [ ] Performance benchmarks show no degradation (or improvement) after refactoring
- [ ] Documentation updated for all changes

## Metrics & Tracking

### CodeNarc Baseline (v3.6.0)
| Priority | Count | Target (v3.6.1) |
|----------|-------|-----------------|
| P1       | 0     | 0               |
| P2       | 224   | <56             |
| P3       | 230   | <144            |
| **Total**| **454** | **<200**      |

### Top Violations to Address
| Violation Type              | Count | Target |
|-----------------------------|-------|--------|
| Instanceof                  | 84    | <20    |
| DuplicateStringLiteral      | 36    | 0      |
| UnnecessaryGString          | 35    | 0      |
| DuplicateNumberLiteral      | 28    | <5     |
| OperatorSpacing             | 28    | 0      |
| BraceFormatting             | 25    | 0      |
| IfStatementBraces           | 21    | 0      |
| ImplementationType          | 9     | 0      |
| NestedForLoop               | 10    | 5      |

### Test Coverage
- Current: 70% overall (70% minimum)
- Target: Maintain >=70% overall, improve low-coverage classes
- Low coverage classes to improve:
  - MatrixAssertions: 15% (needs dedicated assertion tests)
  - ColumnExtension: 31% (needs extension method tests)

## Notes
- This release focuses on code quality and maintainability, not new features
- All changes must maintain backward compatibility
- Performance optimizations are optional (Phase 5) based on measured impact
- CodeNarc violations in ValueConverter.groovy and MatrixBuilder.groovy are currently excluded due to Groovy 5 switch expression syntax not yet supported by CodeNarc 3.5.0
- Consider updating to newer CodeNarc version when Groovy 5 support is added
