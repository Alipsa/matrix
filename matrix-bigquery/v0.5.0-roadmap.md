# Matrix BigQuery v0.5.0 Release Roadmap

This document outlines the required work to prepare matrix-bigquery v0.5.0 for release.

## Summary

v0.5.0 focuses on release hygiene, documentation updates, code quality improvements, and proper logging infrastructure. The module is functionally complete but needs cleanup before production release.

---

## Priority 1: Release Blockers (Must Fix)

### 1.1 [x] Fix POM artifact name
- **File**: `build.gradle` line 91
- **Issue**: `name = 'Matrix Json'` should be `'Matrix BigQuery'`
- **Impact**: Maven Central artifact will have incorrect name
- **Effort**: 1 minute
- **Status**: ✅ Fixed - Changed to 'Matrix BigQuery'

### 1.2 [x] Update README.md versions
- **File**: `readme.md`
- **Issues**:
  - Line 9: Shows version `0.3.2`, should be `0.5.0`
  - Line 7: Shows Groovy `5.0.2`, should be `5.0.3`
  - Line 8: Shows matrix-core `3.5.0`, should be compatible version for release
- **Impact**: Users will download wrong versions
- **Effort**: 5 minutes
- **Status**: ✅ Fixed - Updated to Groovy 5.0.3 and version 0.5.0

### 1.3 [x] Remove debug println statements
- **File**: `src/main/groovy/se/alipsa/matrix/bigquery/Bq.groovy`
- **Issue**: Debug println statements in convertToMatrix (lines 417-419, 428)
- **Reason**: Debug code should not be in production
- **Effort**: 2 minutes
- **Status**: ✅ Fixed - Removed debug println statements

### 1.4 [x] Document sync vs async query execution
- **File**: `src/main/groovy/se/alipsa/matrix/bigquery/Bq.groovy`
- **Issue**: Unclear why synchronous execution is used instead of async
- **Solution**: Document that sync has 10 GB limit but works with emulators, preserve async code for reference
- **Effort**: 15 minutes
- **Status**: ✅ Fixed - Added documentation explaining sync (10 GB limit, emulator compatible) vs async (no limit, production use), preserved async code in comments for future migration

---

## Priority 2: High Priority (Should Fix)

### 2.1 [ ] Add unit tests that run in CI
- **Issue**: All tests are `@Tag("external")`, requiring Google Cloud credentials
- **Impact**: No automated testing in CI/CD pipeline
- **Tasks**:
  - Add unit tests for TypeMapper conversion logic
  - Add unit tests for schema creation
  - Add tests for sanitizeString, convertObjectValue, needsConversion
  - Mock BigQuery client for integration-style tests
- **Target**: At least 60% code coverage from non-external tests
- **Effort**: 4-6 hours

### 2.2 [ ] Fix overly broad exception catching
- **File**: `src/main/groovy/se/alipsa/matrix/bigquery/TypeMapper.groovy` line 69
- **Issue**: `catch (Throwable ignore)` is dangerous and could mask critical errors
- **Solution**: Catch specific exceptions (e.g., `UnsupportedOperationException`, `IllegalArgumentException`)
- **Impact**: Could hide OutOfMemoryError, StackOverflowError, etc.
- **Effort**: 10 minutes

### 2.3 [ ] Refactor the insert method
- **File**: `src/main/groovy/se/alipsa/matrix/bigquery/Bq.groovy`
- **Issue**: The `insert` method is overly long and complex, handling both streaming and fallback logic.
- **Solution**: Break down the method into smaller, single-responsibility methods (e.g., one for streaming, one for the fallback, one for JSON generation).
- **Impact**: Improves readability, maintainability, and testability.
- **Effort**: 1-2 hours

### 2.4 [x] Make sync vs async query execution configurable
- **File**: `src/main/groovy/se/alipsa/matrix/bigquery/Bq.groovy`
- **Task**: Allow users to choose between sync (emulator compatible, 10 GB limit) and async (production, no limit) query execution
- **Solution**: Added `useAsyncQueries` boolean parameter to all constructors (defaults to false)
- **Benefits**:
  - Users can opt into async for production workloads: `new Bq(true)`
  - Tests continue using sync mode with emulators (backward compatible)
  - No breaking changes (sync remains default)
- **Effort**: 1 hour
- **Status**: ✅ Complete - Implemented with comprehensive JavaDoc, updated README with usage examples

---

## Priority 3: Medium Priority (Nice to Have)

### 3.1 [ ] Add comprehensive JavaDoc documentation
- **Files**: All public methods in Bq.groovy, TypeMapper.groovy
- **Missing Documentation**:
  - `insert()` method fallback strategy (streaming → InsertAll)
  - `convertObjectValue()` type conversion rules
  - `waitForTable()` backoff strategy
  - Thread-safety guarantees (or lack thereof)
  - `sanitizeString()` Unicode control character removal rationale
- **Effort**: 2 hours

### 3.2 [ ] Reduce usage of 'def' keyword
- **File**: `src/main/groovy/se/alipsa/matrix/bigquery/Bq.groovy`
- **Issue**: Class is `@CompileStatic` but uses `def` extensively (13+ instances)
- **Impact**: Defeats static compilation benefits, reduces type safety
- **Lines**: 189, 229, 239, 286-288, 338-339, 527, 550, 604
- **Effort**: 30 minutes

### 3.3 [x] Fix typo in comment
- **File**: `Bq.groovy` line 34
- **Issue**: "understand hen inserting" should be "understand when inserting"
- **Effort**: 10 seconds
- **Status**: ✅ Fixed - Corrected typo

### 3.4 [ ] Document unsupported BigQuery types
- **File**: `TypeMapper.groovy`
- **Issue**: Commented-out types (GEOGRAPHY, INTERVAL, JSON, RANGE, RECORD) lack explanation
- **Solution**: Add JavaDoc section explaining which types are not yet supported and why
- **Effort**: 15 minutes

### 3.5 [ ] Make waitForTable timeout configurable
- **File**: `src/main/groovy/se/alipsa/matrix/bigquery/Bq.groovy`
- **Issue**: The `waitForTable` method has a hardcoded timeout of 60 seconds.
- **Solution**: Allow the timeout to be configured, e.g., by passing it as a parameter to the method or to the `Bq` constructor.
- **Impact**: Provides more flexibility for users who may need shorter or longer timeouts.
- **Effort**: 20 minutes

---

## Priority 4: Future Enhancements (v0.6.0+)

### 4.1 [ ] Support additional BigQuery types
- **Types**: GEOGRAPHY, INTERVAL, JSON, RANGE, RECORD
- **Note**: RECORD could be converted to Map (see TypeMapper.groovy line 97)
- **Effort**: Variable (2-8 hours depending on type)

### 4.2 [ ] Add performance benchmarks
- **Goal**: Establish baseline for large dataset operations
- **Metrics**: Insert time, query time, memory usage for 100k, 1M, 10M rows
- **Effort**: 4 hours

### 4.3 [ ] Thread-safety analysis and documentation
- **Task**: Analyze whether Bq class is thread-safe
- **Deliverable**: Documentation stating thread-safety guarantees
- **Effort**: 2 hours

### 4.4 [ ] Improve error messages
- **Task**: Add context to BqException throws (include method name, operation type)
- **Currently**: Many methods just `throw new BqException(e)` without context
- **Effort**: 1 hour

---

## Pre-Release Checklist

Before removing `-SNAPSHOT` from version:

- [x] All Priority 1 items completed
- [ ] All Priority 2 items completed (or moved to backlog with justification)
- [x] All tests passing (including external tests with valid credentials)
- [ ] JavaDoc builds without warnings: `./gradlew :matrix-bigquery:groovydoc`
- [ ] Compilation clean: `./gradlew :matrix-bigquery:compileGroovy --warning-mode=all`
- [ ] Dependencies updated to latest stable versions
- [x] README.md reviewed and accurate
- [ ] Release notes drafted
- [ ] SNAPSHOT suffix removed from build.gradle
- [ ] Git tag created: `v0.5.0`
- [ ] Artifacts published to Maven Central
- [ ] GitHub release created with release notes

---

## Code Quality Metrics

**Current State:**
- Source files: 4 (.groovy)
- Test files: 3 (all external-only)
- Lines of code: ~650 (main), ~300 (test)
- Test coverage: Unknown (external tests don't run in CI)
- Code quality issues identified: 34+

**Target State:**
- Test coverage: ≥60% (non-external tests)
- Zero commented-out code blocks
- All public methods documented with JavaDoc
- Improved exception handling (no overly broad catches)

---

## Dependencies Review

Current dependencies (from build.gradle):

| Dependency | Version | Status | Notes |
|-----------|---------|--------|-------|
| google-cloud-bigquery | 2.56.0 | ⚠️ Check | Verify latest stable |
| google-cloud-resourcemanager | 1.82.0 | ⚠️ Check | Verify latest stable |
| google-auth-library-bom | 1.41.0 | ⚠️ Check | Verify latest stable |
| google-cloud-bigquerystorage | 3.18.0 | ⚠️ Check | Verify latest stable |
| progressbar | 0.10.1 | ✅ Latest | Released 2024-01 |
| testcontainers | 1.21.3 | ⚠️ Check | Verify latest stable |

**Action**: Update all Google Cloud libraries to latest stable versions before release.

---

## Estimated Total Effort

- **Priority 1 (Release Blockers)**: ✅ Complete
- **Priority 2 (High Priority)**: ~5-8 hours remaining (2.4 complete, 2.1-2.3 remain)
- **Priority 3 (Medium Priority)**: 3-4 hours
- **Pre-Release Tasks**: 2 hours
- **Total remaining for quality release**: 7-10 hours

---

## Release Timeline Recommendation

**Recommended approach:**

1. **Quick fix (2-3 days)**: Complete Priority 1 items only, release as-is
   - Pros: Fast release, users get access to new features
   - Cons: Technical debt remains, no CI testing

2. **Quality release (1-2 weeks)**: Complete Priority 1 + Priority 2
   - Pros: Production-ready with improved testing and code quality
   - Cons: Takes longer
   - **Recommended**: This is the better approach for first stable release

3. **Comprehensive release (3-4 weeks)**: Complete all priorities
   - Pros: Excellent code quality, fully documented
   - Cons: Significant time investment for diminishing returns

**Recommendation**: Go with option 2 (Quality release) for v0.5.0
